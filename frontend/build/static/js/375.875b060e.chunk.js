"use strict";(self.webpackChunkair_monitoring_frontend=self.webpackChunkair_monitoring_frontend||[]).push([[375],{21375:(e,t,l)=>{l.r(t),l.d(t,{default:()=>k});var r=l(89379),a=l(65043),o=l(26240),i=l(96446),n=l(85865),s=l(11906),c=l(88911),m=l(53193),d=l(79190),u=l(72221),f=l(32143),p=l(15795),h=l(74605),w=l(51962),g=l(17392),A=l(73216),x=l(69120),j=l(39423),b=l(94505),v=l(79928),F=l(96458),S=l(95187),y=l(70579);const k=()=>{const e=(0,o.A)(),{shiftId:t}=(0,A.g)(),l=(0,A.Zp)(),k=(0,A.zy)(),{currentUser:q}=(0,S.As)(),[N,C]=(0,a.useState)([]),[B,T]=(0,a.useState)([]),[E,I]=(0,a.useState)([]),[D,W]=(0,a.useState)({sampleNumber:"",type:"Background",location:"",pumpNo:"",flowmeter:"",cowlNo:"",filterSize:"25mm",startTime:"",endTime:"",initialFlowrate:"",finalFlowrate:"",averageFlowrate:"",notes:"",isFieldBlank:!1,sampler:""}),[_,P]=(0,a.useState)(null),[L,R]=(0,a.useState)(null),[z,M]=(0,a.useState)(""),[X,U]=(0,a.useState)({}),[H,J]=(0,a.useState)(!1),[O,V]=(0,a.useState)(!1),[Z,G]=(0,a.useState)(null);(0,a.useEffect)((()=>{(async()=>{try{const e=await b.Dv.getAll();C(e.data)}catch(z){console.error("Error fetching users:",z)}})()}),[]),(0,a.useEffect)((()=>{(async()=>{try{const e=await v.A.filterByStatus("Active"),t=e.data||e;T(t)}catch(z){console.error("Error fetching active air pumps:",z)}})()}),[]),(0,a.useEffect)((()=>{(async()=>{try{console.log("Fetching flowmeters...");const e=await F.m.getAll();if(console.log("Equipment response:",e),!e)return void console.error("No response from equipment service");const t=e.equipment||e.data||e;if(console.log("All equipment:",t),!Array.isArray(t))return void console.error("Equipment data is not an array:",t);const l=t.filter((e=>("Bubble flowmeter"===e.equipmentType||"Site flowmeter"===e.equipmentType)&&"active"===e.status));console.log("Filtered flowmeters:",l),console.log("Flowmeter count:",l.length),I(l)}catch(z){var e;console.error("Error fetching active flowmeters:",z),console.error("Error details:",(null===(e=z.response)||void 0===e?void 0:e.data)||z.message)}})()}),[]),(0,a.useEffect)((()=>{(async()=>{try{var e;const o=await b.sA.getById(t);console.log("Full shift response:",o.data),G(o.data);const i=null===(e=k.state)||void 0===e?void 0:e.nextSampleNumber;if(console.log("Next sample number from location:",i),i){var l,a;const e=null===(l=o.data.job)||void 0===l||null===(a=l.project)||void 0===a?void 0:a.projectID;e&&(W((e=>(0,r.A)((0,r.A)({},e),{},{sampleNumber:i.toString()}))),P(e))}const n=(await b.kw.getByShift(t)).data||[],s=n.length+1;if(console.log("Number of samples in shift:",n.length),console.log("This will be sample number:",s,"in this shift"),!o.data.defaultSampler&&n.length>0){const e=n[0];if(console.log("First sample in shift:",e),e.collectedBy){console.log("Setting default sampler from first sample:",e.collectedBy);try{const l=await b.sA.update(t,{defaultSampler:e.collectedBy});console.log("Shift updated with default sampler from first sample:",l),W((t=>(0,r.A)((0,r.A)({},t),{},{sampler:e.collectedBy})))}catch(z){console.error("Error setting default sampler from first sample:",z)}}}else if(o.data.defaultSampler){console.log("Setting default sampler from shift:",o.data.defaultSampler);const e=o.data.defaultSampler._id||o.data.defaultSampler;console.log("Setting sampler ID to:",e),W((t=>(0,r.A)((0,r.A)({},t),{},{sampler:e})))}if(!o.data.defaultFlowmeter&&n.length>0){const e=n[0];if(console.log("First sample in shift for flowmeter:",e),e.flowmeter){console.log("Setting default flowmeter from first sample:",e.flowmeter);try{const l=await b.sA.update(t,{defaultFlowmeter:e.flowmeter});console.log("Shift updated with default flowmeter from first sample:",l),W((t=>(0,r.A)((0,r.A)({},t),{},{flowmeter:e.flowmeter})))}catch(z){console.error("Error setting default flowmeter from first sample:",z)}}}else o.data.defaultFlowmeter&&(console.log("Setting default flowmeter from shift:",o.data.defaultFlowmeter),W((e=>{const t=(0,r.A)((0,r.A)({},e),{},{flowmeter:o.data.defaultFlowmeter});return console.log("Updated form with flowmeter:",t),t})))}catch(o){console.error("Error fetching shift:",o),M("Failed to load shift details")}})()}),[t,k.state]),(0,a.useEffect)((()=>{(async()=>{if(t)try{console.log("Fetching shift details for shiftId:",t);const e=await b.sA.getById(t);console.log("Full shift response:",e);const l=e.data;if(!l.job||!l.job.project)return console.error("No project data found in job"),void M("No project data found for this job");P(l.job.project.projectID),console.log("Project ID set to:",l.job.project.projectID);const r=await b.D4.getById(l.job._id);R(r.data)}catch(z){console.error("Error fetching shift details:",z),M("Failed to fetch shift details")}else M("No shift ID provided")})()}),[t]),(0,a.useEffect)((()=>{if(E.length>0&&Z&&Z.defaultFlowmeter){console.log("Flowmeters loaded, checking for default flowmeter:",Z.defaultFlowmeter),console.log("Available flowmeter references:",E.map((e=>e.equipmentReference)));E.some((e=>e.equipmentReference===Z.defaultFlowmeter))&&!D.flowmeter&&(console.log("Setting default flowmeter from shift after flowmeters loaded"),W((e=>(0,r.A)((0,r.A)({},e),{},{flowmeter:Z.defaultFlowmeter}))))}}),[E,Z,D.flowmeter]);const K=e=>{const{name:t,value:l,checked:a}=e.target;X[t]&&U((e=>(0,r.A)((0,r.A)({},e),{},{[t]:void 0}))),W("isFieldBlank"===t?e=>(0,r.A)((0,r.A)({},e),{},{[t]:a,location:a?"Field blank":e.location}):e=>(0,r.A)((0,r.A)({},e),{},{[t]:l}))};(0,a.useEffect)((()=>{if(D.initialFlowrate)if(D.finalFlowrate){const e=(parseFloat(D.initialFlowrate)+parseFloat(D.finalFlowrate))/2;W((t=>(0,r.A)((0,r.A)({},t),{},{averageFlowrate:Math.round(e).toString()})))}else W((e=>(0,r.A)((0,r.A)({},e),{},{averageFlowrate:Math.round(parseFloat(D.initialFlowrate)).toString()})))}),[D.initialFlowrate,D.finalFlowrate]);const Q=e=>{const t=new Date,l=t.getHours().toString().padStart(2,"0"),a=t.getMinutes().toString().padStart(2,"0"),o="".concat(l,":").concat(a);W((t=>(0,r.A)((0,r.A)({},t),{},{[e]:o})))};return H?(0,y.jsx)(i.A,{sx:{p:{xs:2,sm:3,md:4}},children:(0,y.jsx)(n.A,{children:"Submitting..."})}):(0,y.jsxs)(i.A,{sx:{p:{xs:2,sm:3,md:4}},children:[(0,y.jsx)(s.A,{startIcon:(0,y.jsx)(x.A,{}),onClick:()=>l(-1),sx:{mb:4},children:"Back to Samples"}),(0,y.jsx)(n.A,{variant:"h4",sx:{color:"dark"===e.palette.mode?"#fff":e.palette.secondary[200],mb:4},children:"Add New Sample"}),z&&(0,y.jsx)(n.A,{color:"error",sx:{mb:2},children:z}),(0,y.jsx)(i.A,{component:"form",onSubmit:async e=>{if(e.preventDefault(),M(""),U({}),(()=>{const e={};return D.sampler||(e.sampler="Sampler is required"),D.sampleNumber||(e.sampleNumber="Sample number is required"),D.flowmeter||(e.flowmeter="Flowmeter is required"),D.isFieldBlank||(D.location||(e.location="Location is required"),D.type||(e.type="Type is required"),D.startTime||(e.startTime="Start time is required"),D.initialFlowrate||(e.initialFlowrate="Initial flowrate is required")),U(e),0===Object.keys(e).length})()){J(!0);try{if(!_)throw new Error("Project ID is required");if(null===L||void 0===L||!L._id)throw new Error("Job ID is required");if(!t)throw new Error("Shift ID is required");const e=await b.kw.getByShift(t),a=(e.data||[]).length+1;if(1===a&&D.sampler)try{await b.sA.update(t,{defaultSampler:D.sampler})}catch(z){}if(1===a&&D.flowmeter)try{await b.sA.update(t,{defaultFlowmeter:D.flowmeter})}catch(z){}const o=(0,r.A)((0,r.A)({},D),{},{shift:t,job:L._id,fullSampleID:"".concat(_,"-").concat(D.sampleNumber),collectedBy:D.sampler,flowmeter:D.flowmeter});await b.kw.create(o),setTimeout((()=>{l("/air-monitoring/shift/".concat(t,"/samples"))}),500)}catch(z){var a,o;M((null===(a=z.response)||void 0===a||null===(o=a.data)||void 0===o?void 0:o.message)||z.message||"Failed to create sample")}finally{J(!1)}}},noValidate:!0,children:(0,y.jsxs)(c.A,{spacing:3,sx:{maxWidth:600},children:[(0,y.jsxs)(m.A,{fullWidth:!0,required:!0,error:!!X.sampler,children:[(0,y.jsx)(d.A,{children:"Sampler"}),(0,y.jsx)(u.A,{name:"sampler",value:D.sampler,onChange:K,label:"Sampler",required:!0,children:N.map((e=>(0,y.jsxs)(f.A,{value:e._id,children:[e.firstName," ",e.lastName]},e._id)))}),X.sampler&&(0,y.jsx)(n.A,{variant:"caption",color:"error",sx:{mt:.5},children:X.sampler})]}),(0,y.jsx)(p.A,{name:"sampleNumber",label:"Sample Number",value:D.sampleNumber,onChange:K,required:!0,fullWidth:!0,error:!!X.sampleNumber,helperText:X.sampleNumber?X.sampleNumber:_?"Full Sample ID will be: ".concat(_,"-").concat(D.sampleNumber||"XXX"):"Loading job details..."}),(0,y.jsx)(h.A,{control:(0,y.jsx)(w.A,{name:"isFieldBlank",checked:D.isFieldBlank,onChange:K}),label:"Field Blank"}),!D.isFieldBlank&&(0,y.jsxs)(y.Fragment,{children:[(0,y.jsxs)(m.A,{fullWidth:!0,required:!0,error:!!X.type,children:[(0,y.jsx)(d.A,{children:"Type"}),(0,y.jsxs)(u.A,{name:"type",value:D.type,onChange:K,label:"Type",children:[(0,y.jsx)(f.A,{value:"Background",children:"Background"}),(0,y.jsx)(f.A,{value:"Clearance",children:"Clearance"}),(0,y.jsx)(f.A,{value:"Exposure",children:"Exposure"})]}),X.type&&(0,y.jsx)(n.A,{variant:"caption",color:"error",sx:{mt:.5},children:X.type})]}),(0,y.jsx)(p.A,{name:"location",label:"Location",value:D.location,onChange:K,required:!0,fullWidth:!0,error:!!X.location,helperText:X.location})]}),D.isFieldBlank&&(0,y.jsx)(p.A,{name:"location",label:"Location",value:"Field blank",disabled:!0,required:!0,fullWidth:!0}),!D.isFieldBlank&&(0,y.jsxs)(y.Fragment,{children:[(0,y.jsxs)(m.A,{fullWidth:!0,children:[(0,y.jsx)(d.A,{children:"Pump No."}),(0,y.jsxs)(u.A,{name:"pumpNo",value:D.pumpNo,onChange:K,label:"Pump No.",children:[(0,y.jsx)(f.A,{value:"",children:(0,y.jsx)("em",{children:"Select a pump"})}),B.map((e=>(0,y.jsxs)(f.A,{value:e.pumpReference,children:[e.pumpReference," - ",e.pumpDetails]},e._id)))]})]}),(0,y.jsx)(p.A,{name:"cowlNo",label:"Cowl No.",value:D.cowlNo,onChange:K,required:!0,fullWidth:!0}),(0,y.jsxs)(m.A,{fullWidth:!0,children:[(0,y.jsx)(d.A,{children:"Filter Size"}),(0,y.jsxs)(u.A,{name:"filterSize",value:D.filterSize,onChange:K,label:"Filter Size",children:[(0,y.jsx)(f.A,{value:"25mm",children:"25mm"}),(0,y.jsx)(f.A,{value:"13mm",children:"13mm"})]})]})]}),(0,y.jsxs)(m.A,{fullWidth:!0,required:!0,error:!!X.flowmeter,children:[(0,y.jsx)(d.A,{children:"Flowmeter"}),(0,y.jsxs)(u.A,{name:"flowmeter",value:D.flowmeter,onChange:K,label:"Flowmeter",required:!0,children:[(0,y.jsx)(f.A,{value:"",children:(0,y.jsx)("em",{children:"Select a flowmeter"})}),E.map((e=>(0,y.jsxs)(f.A,{value:e.equipmentReference,children:[e.equipmentReference," - ",e.brandModel," (",e.equipmentType,")"]},e._id)))]}),X.flowmeter&&(0,y.jsx)(n.A,{variant:"caption",color:"error",sx:{mt:.5},children:X.flowmeter}),(0,y.jsxs)(n.A,{variant:"caption",sx:{mt:.5,color:"text.secondary"},children:["Current value: ",D.flowmeter||"None"," | Available options:"," ",E.map((e=>e.equipmentReference)).join(", ")]})]}),!D.isFieldBlank&&(0,y.jsxs)(y.Fragment,{children:[(0,y.jsxs)(i.A,{sx:{display:"flex",gap:1},children:[(0,y.jsx)(p.A,{name:"startTime",label:"Start Time",type:"time",value:D.startTime,onChange:K,required:!0,fullWidth:!0,error:!!X.startTime,helperText:X.startTime,InputLabelProps:{shrink:!0},inputProps:{step:60}}),(0,y.jsx)(g.A,{onClick:()=>Q("startTime"),sx:{alignSelf:"flex-end",mb:1},children:(0,y.jsx)(j.A,{})})]}),(0,y.jsx)(p.A,{name:"initialFlowrate",label:"Initial Flowrate (L/min)",type:"number",value:D.initialFlowrate,onChange:K,required:!0,fullWidth:!0,error:!!X.initialFlowrate,helperText:X.initialFlowrate,inputProps:{step:"0.1"}}),(0,y.jsxs)(i.A,{sx:{display:"flex",gap:1},children:[(0,y.jsx)(p.A,{name:"endTime",label:"End Time",type:"time",value:D.endTime,onChange:K,fullWidth:!0,InputLabelProps:{shrink:!0},inputProps:{step:60}}),(0,y.jsx)(g.A,{onClick:()=>Q("endTime"),sx:{alignSelf:"flex-end",mb:1},children:(0,y.jsx)(j.A,{})})]}),(0,y.jsx)(p.A,{name:"finalFlowrate",label:"Final Flowrate (L/min)",type:"number",value:D.finalFlowrate,onChange:K,fullWidth:!0,inputProps:{step:"0.1"}}),(0,y.jsx)(p.A,{name:"averageFlowrate",label:"Average Flowrate",value:D.averageFlowrate,disabled:!0,required:!0,fullWidth:!0})]}),(0,y.jsx)(p.A,{name:"notes",label:"Notes",value:D.notes,onChange:K,multiline:!0,rows:3,fullWidth:!0}),(0,y.jsxs)(i.A,{sx:{display:"flex",gap:2,justifyContent:"flex-end"},children:[(0,y.jsx)(s.A,{variant:"outlined",onClick:()=>l(-1),children:"Cancel"}),(0,y.jsx)(s.A,{type:"submit",variant:"contained",sx:{backgroundColor:e.palette.primary.main,"&:hover":{backgroundColor:e.palette.primary.dark}},children:"Save Sample"})]})]})})]})}}}]);
//# sourceMappingURL=375.875b060e.chunk.js.map