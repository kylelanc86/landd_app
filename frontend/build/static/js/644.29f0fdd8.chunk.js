"use strict";(self.webpackChunkair_monitoring_frontend=self.webpackChunkair_monitoring_frontend||[]).push([[644],{81644:(e,s,n)=>{n.r(s),n.d(s,{default:()=>B});var t=n(89379),a=n(65043),l=n(26240),i=n(79650),o=n(71806),r=n(84882),c=n(28076),d=n(10039),u=n(73460),p=n(15795),m=n(88911),f=n(85865),h=n(96446),x=n(63336),g=n(53193),A=n(78492),b=n(74605),j=n(14256),y=n(11906),C=n(79190),S=n(72221),v=n(32143),D=n(90035),w=n(26600),k=n(35316),_=n(29347),I=n(73216),F=n(69120),L=n(10155),E=n(94505),N=n(85271),T=n(46256),M=n(70579);const R="ldc_analysis_progress",P=a.memo((e=>{let{sample:s,analysis:n,onAnalysisChange:t,onFibreCountChange:C,onKeyDown:S,onClearTable:v,isFilterUncountable:D,calculateConcentration:w,getReportedConcentration:k,inputRefs:_,isReadOnly:I}=e;(0,l.A)();const F=(0,a.useMemo)((()=>(0,M.jsx)(i.A,{children:(0,M.jsxs)(o.A,{size:"small",sx:{tableLayout:"fixed"},children:[(0,M.jsx)(r.A,{children:(0,M.jsxs)(c.A,{children:[(0,M.jsx)(d.A,{sx:{width:"80px"},children:"Range"}),Array.from({length:20},((e,s)=>(0,M.jsx)(d.A,{align:"center",sx:{width:"40px",p:.5},children:s+1},s)))]})}),(0,M.jsxs)(u.A,{children:[n.fibreCounts.map(((e,n)=>(0,M.jsxs)(c.A,{children:[(0,M.jsx)(d.A,{sx:{p:.5},children:"".concat(20*n+1,"-").concat(20*(n+1))}),e.map(((e,t)=>(0,M.jsx)(d.A,{align:"center",sx:{p:.5},children:(0,M.jsx)(p.A,{type:"text",value:e,onChange:e=>C(s._id,n,t,e.target.value),onKeyDown:e=>S(e,s._id,n,t),size:"small",disabled:D(s._id)||I,inputRef:e=>{_.current["".concat(s._id,"-").concat(n,"-").concat(t)]=e},sx:{width:"40px","& .MuiInputBase-input":{p:.5,textAlign:"center"},"& .MuiInputBase-input.Mui-disabled":{WebkitTextFillColor:"rgba(0, 0, 0, 0.6)"}}})},t)))]},n))),(0,M.jsx)(c.A,{children:(0,M.jsx)(d.A,{colSpan:21,children:(0,M.jsxs)(m.A,{direction:"row",spacing:4,justifyContent:"center",children:[(0,M.jsxs)(f.A,{children:["Fibres Counted: ",n.fibresCounted||0]}),(0,M.jsxs)(f.A,{children:["Fields Counted: ",n.fieldsCounted||0]})]})})}),(0,M.jsx)(c.A,{children:(0,M.jsx)(d.A,{colSpan:21,children:(0,M.jsxs)(m.A,{direction:"row",spacing:4,justifyContent:"center",sx:{mt:2},children:[(0,M.jsxs)(h.A,{children:[(0,M.jsx)(f.A,{variant:"subtitle2",color:"text.secondary",children:"Calculated Concentration"}),(0,M.jsxs)(f.A,{variant:"h4",children:[w(s._id)||"N/A"," fibres/mL"]})]}),(0,M.jsxs)(h.A,{children:[(0,M.jsx)(f.A,{variant:"subtitle2",color:"text.secondary",children:"Reported Concentration"}),(0,M.jsxs)(f.A,{variant:"h4",children:[k(s._id)," fibres/mL"]})]})]})})})]})]})})),[n,s._id,C,S,D,w,k]);return(0,M.jsx)(x.A,{sx:{p:3},children:(0,M.jsxs)(m.A,{spacing:3,children:[(0,M.jsxs)(f.A,{variant:"h3",children:[s.fullSampleID," : Cowl ",s.cowlNo]}),(0,M.jsx)(m.A,{direction:{xs:"column",sm:"row"},spacing:3,children:(0,M.jsxs)(m.A,{direction:{xs:"column",sm:"row"},spacing:3,children:[(0,M.jsxs)(g.A,{component:"fieldset",children:[(0,M.jsx)(f.A,{variant:"subtitle1",sx:{mb:1},children:"Edges/Distribution"}),(0,M.jsxs)(A.A,{row:!0,value:n.edgesDistribution||"",onChange:e=>t(s._id,"edgesDistribution",e.target.value),children:[(0,M.jsx)(b.A,{value:"pass",control:(0,M.jsx)(j.A,{}),label:"Pass",disabled:I}),(0,M.jsx)(b.A,{value:"fail",control:(0,M.jsx)(j.A,{}),label:(0,M.jsx)("span",{style:{color:"red"},children:"Fail"}),disabled:I})]})]}),(0,M.jsx)(h.A,{sx:{width:24}}),(0,M.jsxs)(g.A,{component:"fieldset",children:[(0,M.jsx)(f.A,{variant:"subtitle1",sx:{mb:1},children:"Background Dust"}),(0,M.jsxs)(A.A,{row:!0,value:n.backgroundDust||"",onChange:e=>t(s._id,"backgroundDust",e.target.value),children:[(0,M.jsx)(b.A,{value:"low",control:(0,M.jsx)(j.A,{}),label:"Low",disabled:I}),(0,M.jsx)(b.A,{value:"medium",control:(0,M.jsx)(j.A,{}),label:"Medium",disabled:I}),(0,M.jsx)(b.A,{value:"high",control:(0,M.jsx)(j.A,{}),label:"High",disabled:I}),(0,M.jsx)(b.A,{value:"fail",control:(0,M.jsx)(j.A,{}),label:(0,M.jsx)("span",{style:{color:"red"},children:"Fail"}),disabled:I})]})]})]})}),(0,M.jsxs)(h.A,{sx:{position:"relative"},children:[(0,M.jsxs)(h.A,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[(0,M.jsx)(f.A,{variant:"subtitle1",children:"Fibre Counts"}),(0,M.jsx)(f.A,{variant:"subtitle2",children:'"Spacebar" = 10 zeros, "/" = half fibre'}),!I&&(0,M.jsx)(y.A,{startIcon:(0,M.jsx)(L.A,{}),onClick:()=>v(s._id),disabled:D(s._id),size:"small",color:"error",children:"Clear"})]}),D(s._id)&&(0,M.jsx)(h.A,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:1,pointerEvents:"none"},children:(0,M.jsx)(f.A,{variant:"h4",sx:{color:"error.main",fontWeight:"bold",textShadow:"2px 2px 4px rgba(0,0,0,0.2)"},children:"Filter Uncountable"})}),F]})]})})})),B=()=>{const e=(0,l.A)(),{shiftId:s}=(0,I.g)(),n=(0,I.Zp)(),[i,o]=(0,a.useState)([]),[r,c]=(0,a.useState)({microscope:"",testSlide:"",testSlideLines:""}),[d,u]=(0,a.useState)({}),[p,L]=(0,a.useState)(!1),[B,z]=(0,a.useState)(null),O=(0,a.useRef)({}),[U,K]=(0,a.useState)(!1),[W,J]=(0,a.useState)(!1),[H,Y]=(0,a.useState)(!0),[$,q]=(0,a.useState)(null),[Z,G]=(0,a.useState)(!1),[Q,V]=(0,a.useState)([]),[X,ee]=(0,a.useState)(""),[se,ne]=(0,a.useState)("");(0,a.useEffect)((()=>{const e=performance.now();G(!0),console.log("Initial render took ".concat(performance.now()-e,"ms"))}),[]),(0,a.useEffect)((()=>{let e=!0;return(async()=>{const n=performance.now();try{var a;Y(!0),console.log("Starting data fetch...");const l=performance.now(),i=await E.sampleService.getByShift(s),r=await E.shiftService.getById(s);if(!e)return;ne(r.data.status),console.log("API fetch took ".concat(performance.now()-l,"ms")),console.log("Sample count:",i.data.length);const d=performance.now(),p=i.data.sort(((e,s)=>{const n=e.fullSampleID.match(/-(\d+)$/),t=s.fullSampleID.match(/-(\d+)$/);return(n?parseInt(n[1],10):0)-(t?parseInt(t[1],10):0)}));console.log("Sorting took ".concat(performance.now()-d,"ms"));const m=performance.now(),f={};p.forEach((e=>{e.analysis?f[e._id]={microscope:e.analysis.microscope||"",testSlide:e.analysis.testSlide||"",testSlideLines:e.analysis.testSlideLines||"",edgesDistribution:e.analysis.edgesDistribution||"",backgroundDust:e.analysis.backgroundDust||"",fibreCounts:Array.isArray(e.analysis.fibreCounts)&&5===e.analysis.fibreCounts.length?e.analysis.fibreCounts.map((e=>Array.isArray(e)&&20===e.length?e:Array(20).fill(""))):Array(5).fill().map((()=>Array(20).fill(""))),fibresCounted:e.analysis.fibresCounted||0,fieldsCounted:e.analysis.fieldsCounted||0}:f[e._id]={microscope:"",testSlide:"",testSlideLines:"",edgesDistribution:"",backgroundDust:"",fibreCounts:Array(5).fill().map((()=>Array(20).fill(""))),fibresCounted:0,fieldsCounted:0}}));const h=p.find((e=>{var s;return null===(s=e.analysis)||void 0===s?void 0:s.microscope}));null!==h&&void 0!==h&&h.analysis&&c({microscope:h.analysis.microscope||"",testSlide:h.analysis.testSlide||"",testSlideLines:h.analysis.testSlideLines||""}),null!==(a=r.data)&&void 0!==a&&a.analysedBy&&ee(r.data.analysedBy),console.log("Initialization took ".concat(performance.now()-m,"ms"));const x=performance.now(),g=localStorage.getItem(R);if(g){const e=JSON.parse(g);if(e.shiftId===s){null!==h&&void 0!==h&&h.analysis||c(e.analysisDetails);const s=(0,t.A)({},f);Object.keys(e.sampleAnalyses).forEach((n=>{s[n]&&(s[n]=(0,t.A)((0,t.A)({},s[n]),e.sampleAnalyses[n]))})),u(s)}else u(f)}else u(f);console.log("Storage operations took ".concat(performance.now()-x,"ms")),o(p),q(null),console.log("Total data operations took ".concat(performance.now()-n,"ms"))}catch(l){if(!e)return;console.error("Error fetching data:",l),q("Failed to load data. Please try again later.")}finally{e&&Y(!1)}})(),()=>{e=!1}}),[s]),(0,a.useEffect)((()=>{if(i.length>0){const e=performance.now();requestAnimationFrame((()=>{console.log("Samples render took ".concat(performance.now()-e,"ms"))}))}}),[i]),(0,a.useEffect)((()=>{E.Dv.getAll().then((e=>{V(e.data||[])}))}),[]);const te=e=>{c((0,t.A)((0,t.A)({},r),{},{[e.target.name]:e.target.value}))},ae=(0,a.useCallback)(((e,s,n)=>{u((a=>(0,t.A)((0,t.A)({},a),{},{[e]:(0,t.A)((0,t.A)({},a[e]),{},{[s]:n})})))}),[]),le=(0,a.useCallback)(((e,s,n,a)=>{const l="/"===a?"0.5":a;if(isNaN(l)&&""!==a)return;u((a=>{const i=(0,t.A)({},a),o=[...i[e].fibreCounts];o[s][n]=l;let r=0,c=0;return o.forEach((e=>{e.forEach((e=>{if(""!==e){const s=parseFloat(e);isNaN(s)||(r+=s,c+=1)}}))})),i[e]=(0,t.A)((0,t.A)({},i[e]),{},{fibreCounts:o,fibresCounted:parseFloat(r.toFixed(1)),fieldsCounted:c}),i}));const i=n+1,o=s;if(i<20){const s=O.current["".concat(e,"-").concat(o,"-").concat(i)];s&&s.focus()}else if(s<4){const s=O.current["".concat(e,"-").concat(o+1,"-0")];s&&s.focus()}}),[]),ie=(0,a.useCallback)(((e,s,n,a)=>{" "===e.key&&(e.preventDefault(),u((e=>{const l=(0,t.A)({},e),i=[...l[s].fibreCounts];let o=n,r=a;for(let s=0;s<10;s++){const e=a+s;if(e<20)i[n][e]="0",o=n,r=e;else{const s=n+1;s<5&&(i[s][e-20]="0",o=s,r=e-20)}}let c=0,d=0;i.forEach((e=>{e.forEach((e=>{if(""!==e){const s=parseFloat(e);isNaN(s)||(c+=s,d+=1)}}))})),l[s]=(0,t.A)((0,t.A)({},l[s]),{},{fibreCounts:i,fibresCounted:parseFloat(c.toFixed(1)),fieldsCounted:d});let u=o,p=r+1;for(;u<5;){for(;p<20;){if(""===i[u][p]){const e=O.current["".concat(s,"-").concat(u,"-").concat(p)];if(e){setTimeout((()=>{e.focus()}),0);break}}p++}if(p<20)break;u++,p=0}return l})))}),[]),oe=(0,a.useCallback)((e=>{z(e),L(!0)}),[]),re=e=>{const s=d[e];return"fail"===(null===s||void 0===s?void 0:s.edgesDistribution)||"fail"===(null===s||void 0===s?void 0:s.backgroundDust)},ce=e=>{const s=d[e],n=i.find((s=>s._id===e));if(!s||!n)return null;const t=parseFloat(s.fibresCounted)||0,a=parseInt(s.fieldsCounted)||0,l=parseFloat(n.averageFlowrate)||0,o=((e,s)=>{if(!e||!s)return 0;const n=new Date("2000-01-01T".concat(e)),t=new Date("2000-01-01T".concat(s));return t<n&&t.setDate(t.getDate()+1),Math.round((t-n)/6e4)})(n.startTime,n.endTime);if(0===a||0===l||0===o)return null;return parseFloat(((t<10?10:t)/a*5e4*(1/(1e3*l*o))).toFixed(3))},de=e=>{const s=d[e],n=parseFloat(ce(e));return n?n<.0149&&s.fibresCounted<10?"<0.01":n.toFixed(3):"N/A"},ue=async e=>{e.preventDefault();try{var t;console.log("Starting analysis submission..."),console.log("Analysis Details:",r),console.log("Sample Analyses:",d);const e=i.map((async e=>{const s=d[e._id];if(s){const t={analysis:{microscope:r.microscope,testSlide:r.testSlide,testSlideLines:r.testSlideLines,edgesDistribution:s.edgesDistribution,backgroundDust:s.backgroundDust,fibreCounts:s.fibreCounts,fibresCounted:s.fibresCounted,fieldsCounted:s.fieldsCounted,reportedConcentration:de(e._id)}};console.log("Updating sample ".concat(e.fullSampleID," with data:"),JSON.stringify(t,null,2));try{const s=await E.sampleService.update(e._id,t);return console.log("Update response for ".concat(e.fullSampleID,":"),s),s}catch($){var n;throw console.error("Error updating sample ".concat(e.fullSampleID,":"),(null===(n=$.response)||void 0===n?void 0:n.data)||$),$}}})),a=await Promise.all(e);console.log("All sample updates completed:",a);const l=(await E.shiftService.getById(s)).data,o=null===l||void 0===l||null===(t=l.job)||void 0===t?void 0:t._id;await E.shiftService.update(s,{status:"analysis_complete",analysedBy:X,analysisDate:(new Date).toISOString()}),n(o?"/air-monitoring/jobs/".concat(o,"/shifts"):"/air-monitoring/shifts")}catch($){console.error("Error finalizing analysis:",$),q("Failed to finalize analysis. Please try again.")}},pe=(0,a.useCallback)((e=>{let{index:s,style:n}=e;const t=i[s];return(0,M.jsx)("div",{style:n,children:(0,M.jsx)(P,{sample:t,analysis:d[t._id],onAnalysisChange:ae,onFibreCountChange:le,onKeyDown:ie,onClearTable:oe,isFilterUncountable:re,calculateConcentration:ce,getReportedConcentration:de,inputRefs:O,isReadOnly:"analysis_complete"===se},t._id)})}),[i,d,ae,le,ie,oe,re,ce,de,se]);return H?(0,M.jsx)(h.A,{sx:{p:{xs:2,sm:3,md:4}},children:(0,M.jsx)(f.A,{children:"Loading..."})}):$?(0,M.jsx)(h.A,{sx:{p:{xs:2,sm:3,md:4}},children:(0,M.jsx)(f.A,{color:"error",children:$})}):(0,M.jsxs)(h.A,{sx:{p:{xs:2,sm:3,md:4}},children:[(0,M.jsx)(y.A,{startIcon:(0,M.jsx)(F.A,{}),onClick:()=>n("/air-monitoring/shift/".concat(s,"/samples")),sx:{mb:4},children:"Back to Samples"}),(0,M.jsx)(f.A,{variant:"h2",sx:{color:"dark"===e.palette.mode?"#fff":e.palette.secondary[200],mb:4},children:"Microscope Calibration"}),(0,M.jsx)(m.A,{direction:{xs:"column",sm:"row"},spacing:2,alignItems:"center",mb:3,children:(0,M.jsxs)(g.A,{fullWidth:!0,sx:{maxWidth:300},children:[(0,M.jsx)(C.A,{children:"Analyst"}),(0,M.jsx)(S.A,{value:X,label:"Analyst",onChange:e=>ee(e.target.value),disabled:"analysis_complete"===se,children:Q.map((e=>(0,M.jsxs)(v.A,{value:e.firstName+" "+e.lastName,children:[e.firstName," ",e.lastName]},e._id)))})]})}),(0,M.jsx)(h.A,{component:"form",onSubmit:ue,children:(0,M.jsxs)(m.A,{spacing:4,children:[(0,M.jsx)(x.A,{sx:{p:3},children:(0,M.jsxs)(m.A,{spacing:3,children:[(0,M.jsx)(f.A,{variant:"h3",children:"Microscope Calibration"}),(0,M.jsxs)(m.A,{direction:{xs:"column",sm:"row"},spacing:3,children:[(0,M.jsxs)(g.A,{component:"fieldset",children:[(0,M.jsx)(f.A,{variant:"subtitle1",sx:{mb:1},children:"Microscope"}),(0,M.jsxs)(A.A,{row:!0,name:"microscope",value:r.microscope,onChange:te,children:[(0,M.jsx)(b.A,{value:"PCM1",control:(0,M.jsx)(j.A,{}),label:"PCM1",disabled:"analysis_complete"===se}),(0,M.jsx)(b.A,{value:"PCM2",control:(0,M.jsx)(j.A,{}),label:"PCM2",disabled:"analysis_complete"===se})]})]}),(0,M.jsx)(h.A,{sx:{width:24}}),(0,M.jsxs)(g.A,{component:"fieldset",children:[(0,M.jsx)(f.A,{variant:"subtitle1",sx:{mb:1},children:"Test Slide"}),(0,M.jsxs)(A.A,{row:!0,name:"testSlide",value:r.testSlide,onChange:te,children:[(0,M.jsx)(b.A,{value:"LD-TS1",control:(0,M.jsx)(j.A,{}),label:"LD-TS1",disabled:"analysis_complete"===se}),(0,M.jsx)(b.A,{value:"LD-TS2",control:(0,M.jsx)(j.A,{}),label:"LD-TS2",disabled:"analysis_complete"===se})]})]}),(0,M.jsx)(h.A,{sx:{width:24}}),(0,M.jsxs)(g.A,{component:"fieldset",children:[(0,M.jsx)(f.A,{variant:"subtitle1",sx:{mb:1},children:"Test Slide Lines"}),(0,M.jsxs)(A.A,{row:!0,name:"testSlideLines",value:r.testSlideLines,onChange:te,children:[(0,M.jsx)(b.A,{value:"partial 5",control:(0,M.jsx)(j.A,{}),label:"Partial 5",disabled:"analysis_complete"===se}),(0,M.jsx)(b.A,{value:"6",control:(0,M.jsx)(j.A,{}),label:"6",disabled:"analysis_complete"===se})]})]})]})]})}),i.length<=5?i.map((e=>(0,M.jsx)(P,{sample:e,analysis:d[e._id],onAnalysisChange:ae,onFibreCountChange:le,onKeyDown:ie,onClearTable:oe,isFilterUncountable:re,calculateConcentration:ce,getReportedConcentration:de,inputRefs:O,isReadOnly:"analysis_complete"===se},e._id))):(0,M.jsx)(h.A,{sx:{height:"calc(100vh - 300px)",minHeight:"500px"},children:(0,M.jsx)(T.Ay,{children:e=>{let{height:s,width:n}=e;return(0,M.jsx)(N.Y1,{height:s,width:n,itemCount:i.length,itemSize:400,overscanCount:2,children:pe})}})}),(0,M.jsxs)(h.A,{sx:{display:"flex",justifyContent:"flex-end",mt:3,gap:2},children:[(0,M.jsx)(y.A,{variant:"outlined",onClick:()=>{r.microscope||r.testSlide||r.testSlideLines||i.some((e=>{const s=d[e._id];return!!s&&(!(!s.edgesDistribution&&!s.backgroundDust)||s.fibresCounted>0||s.fieldsCounted>0)}))?J(!0):n(-1)},sx:{color:e.palette.primary.main,borderColor:e.palette.primary.main,"&:hover":{borderColor:e.palette.primary.dark}},children:"Cancel"}),"analysis_complete"!==se&&(0,M.jsxs)(M.Fragment,{children:[(0,M.jsx)(y.A,{variant:"contained",onClick:()=>{console.log("Save and Close button clicked");const e={shiftId:s,analysisDetails:r,sampleAnalyses:d,timestamp:(new Date).toISOString()};try{localStorage.setItem(R,JSON.stringify(e)),console.log("Progress data saved successfully"),n(-1)}catch($){console.error("Error saving progress data:",$)}},sx:{backgroundColor:e.palette.primary[400],"&:hover":{backgroundColor:e.palette.primary[500]}},children:"Save & Close"}),(0,M.jsx)(y.A,{variant:"contained",onClick:ue,disabled:!(()=>{if(console.log("Checking analysis completion..."),!r.microscope||!r.testSlide||!r.testSlideLines)return console.log("Analysis details incomplete:",{microscope:r.microscope,testSlide:r.testSlide,testSlideLines:r.testSlideLines}),!1;const e=i.filter((e=>{const s=d[e._id];if(!s)return console.log("No analysis found for sample ".concat(e.fullSampleID)),!0;if(!s.edgesDistribution||!s.backgroundDust)return console.log("Sample ".concat(e.fullSampleID," missing edges/distribution or background dust:"),{edgesDistribution:s.edgesDistribution,backgroundDust:s.backgroundDust}),!0;if("fail"===s.edgesDistribution||"fail"===s.backgroundDust)return console.log("Sample ".concat(e.fullSampleID," is uncountable, skipping fibre counts")),!1;return!!s.fibreCounts.some(((s,n)=>{const t=s.filter((e=>""===e||null===e||"undefined"===typeof e));return t.length>0&&console.log("Sample ".concat(e.fullSampleID," has empty cells in row ").concat(n+1,":"),t),t.length>0}))&&(console.log("Sample ".concat(e.fullSampleID," has empty fibre count cells")),!0)}));return e.length>0?(console.log("Incomplete samples:",e.map((e=>e.fullSampleID))),!1):(console.log("All samples are complete!"),!0)})(),sx:{backgroundColor:e.palette.primary.main,"&:hover":{backgroundColor:e.palette.primary.dark},"&.Mui-disabled":{backgroundColor:e.palette.grey[700],color:e.palette.grey[500]}},children:"Finalise Analysis"})]})]}),(0,M.jsxs)(D.A,{open:W,onClose:()=>J(!1),children:[(0,M.jsx)(w.A,{children:"Discard Changes?"}),(0,M.jsx)(k.A,{children:(0,M.jsx)(f.A,{children:"You have unsaved changes. Are you sure you want to discard them?"})}),(0,M.jsxs)(_.A,{children:[(0,M.jsx)(y.A,{onClick:()=>J(!1),children:"Continue Editing"}),(0,M.jsx)(y.A,{onClick:()=>n(-1),color:"error",children:"Discard Changes"})]})]})]})})]})}}}]);
//# sourceMappingURL=644.29f0fdd8.chunk.js.map