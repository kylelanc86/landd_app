"use strict";(self.webpackChunkair_monitoring_frontend=self.webpackChunkair_monitoring_frontend||[]).push([[974],{25974:(e,t,s)=>{s.r(t),s.d(t,{default:()=>Y});var o=s(89379),i=s(65043),a=s(96446),r=s(81637),n=s(67254),c=s(17392),l=s(85865),d=s(11906),p=s(12110),h=s(26494),u=s(15795),m=s(79650),x=s(63336),A=s(71806),g=s(84882),j=s(28076),y=s(10039),v=s(73460),f=s(43845),b=s(90035),w=s(26600),I=s(35316),S=s(68903),C=s(53193),D=s(79190),R=s(72221),E=s(32143),z=s(29347),M=s(73158),k=s(87332),B=s(70141),T=s(59662),_=s(70579);const P=(0,T.A)((0,_.jsx)("path",{d:"M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8zm2 16H8v-2h8zm0-4H8v-2h8zm-3-5V3.5L18.5 9z"}),"Description");var W=s(51387),F=s(83560),L=s(72429);const U=(0,T.A)((0,_.jsx)("path",{d:"M5 20h14v-2H5zm0-10h4v6h6v-6h4l-7-7z"}),"Upload");var H=s(73216),N=s(63777),q=s(88027),K=s(45360);var J=s(21291);const Y=()=>{var e;const t=N.LU,T=(0,H.Zp)(),{clearanceId:Y}=(0,H.g)(),[V,Z]=(0,i.useState)([]),[G,O]=(0,i.useState)(null),[Q,X]=(0,i.useState)(!0),[$,ee]=(0,i.useState)(null),[te,se]=(0,i.useState)(!1),[oe,ie]=(0,i.useState)(null),[ae,re]=(0,i.useState)({open:!1,message:"",severity:"success"}),[ne,ce]=(0,i.useState)({locationDescription:"",materialDescription:"",asbestosType:"non-friable",photograph:"",notes:""}),[le,de]=(0,i.useState)(null),[pe,he]=(0,i.useState)(null),[ue,me]=(0,i.useState)(null),[xe,Ae]=(0,i.useState)(!1),[ge,je]=(0,i.useState)(null),[ye,ve]=(0,i.useState)(!1),[fe,be]=(0,i.useState)(!1),[we,Ie]=(0,i.useState)([]),[Se,Ce]=(0,i.useState)(!1),[De,Re]=(0,i.useState)(null),[Ee,ze]=(0,i.useState)(!1),[Me,ke]=(0,i.useState)(null);(0,i.useEffect)((()=>{Be()}),[Y]);const Be=async()=>{try{X(!0);const[e,t]=await Promise.all([K.A.getItems(Y),K.A.getById(Y)]);console.log("Clearance items API response:",e),console.log("Clearance API response:",t),Z(e||[]),O(t)}catch(e){console.error("Error fetching data:",e),ee("Failed to load data")}finally{X(!1)}},Te=()=>{ce({locationDescription:"",materialDescription:"",asbestosType:"non-friable",photograph:"",notes:""}),de(null),he(null),me(null)},_e=e=>{switch(e){case"friable":return"error";case"non-friable":return"warning";default:return"default"}},Pe=async e=>{const t=e.target.files[0];if(t){he(t),me({type:"processing",message:"Processing image..."});try{const e=Math.round(t.size/1024),s=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:500;return e.size/1024>t}(t,300);if(s){console.log("Compressing image..."),me({type:"compressing",message:"Compressing image..."});const s=await function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise(((s,o)=>{const{maxWidth:i=1e3,maxHeight:a=1e3,quality:r=.75,maxSizeKB:n=300}=t;if(!e.type.startsWith("image/"))return void o(new Error("File is not an image"));const c=document.createElement("canvas"),l=c.getContext("2d"),d=new Image;d.onload=()=>{let{width:t,height:o}=d;if(t>i||o>a){const e=Math.min(i/t,a/o);t*=e,o*=e}c.width=t,c.height=o,l.drawImage(d,0,0,t,o);let p=c.toDataURL("image/jpeg",r);const h=.75*p.length/1024;if(h>n&&r>.4){const e=Math.max(.4,r*(n/h));p=c.toDataURL("image/jpeg",e)}console.log("Image compressed: ".concat(e.size/1024,"KB -> ").concat(.75*p.length/1024,"KB")),s(p)},d.onerror=()=>{o(new Error("Failed to load image"))};const p=new FileReader;p.onload=e=>{d.src=e.target.result},p.onerror=()=>{o(new Error("Failed to read file"))},p.readAsDataURL(e)}))}(t,{maxWidth:1e3,maxHeight:1e3,quality:.75,maxSizeKB:300}),i=Math.round(.75*s.length/1024),a=Math.round((e-i)/e*100);de(s),ce((0,o.A)((0,o.A)({},ne),{},{photograph:s})),me({type:"success",message:"Compressed: ".concat(e,"KB \u2192 ").concat(i,"KB (").concat(a,"% reduction)")}),console.log("Image compressed successfully")}else{const s=new FileReader;s.onload=t=>{de(t.target.result),ce((0,o.A)((0,o.A)({},ne),{},{photograph:t.target.result})),me({type:"info",message:"No compression needed (".concat(e,"KB)")})},s.readAsDataURL(t)}}catch($){console.error("Error processing image:",$);const s=new FileReader;s.onload=e=>{de(e.target.result),ce((0,o.A)((0,o.A)({},ne),{},{photograph:e.target.result})),me({type:"warning",message:"Compression failed, using original image"})},s.readAsDataURL(t)}}};return Q?(0,_.jsx)(a.A,{display:"flex",justifyContent:"center",alignItems:"center",height:"400px",children:(0,_.jsx)(r.A,{})}):$?(0,_.jsx)(a.A,{m:"20px",children:(0,_.jsx)(n.A,{severity:"error",children:$})}):(0,_.jsx)(q.A,{requiredPermissions:["asbestos.view"],children:(0,_.jsxs)(a.A,{m:"20px",children:[(0,_.jsxs)(a.A,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[(0,_.jsxs)(a.A,{display:"flex",alignItems:"center",gap:2,children:[(0,_.jsx)(c.A,{onClick:()=>T("/clearances/asbestos"),color:"primary",children:(0,_.jsx)(k.A,{})}),(0,_.jsxs)(a.A,{children:[(0,_.jsx)(l.A,{variant:"h2",color:t.grey[100],fontWeight:"bold",sx:{mb:"5px"},children:"Clearance Items"}),G&&(0,_.jsxs)(l.A,{variant:"h6",color:t.secondary[500],children:[(null===(e=G.projectId)||void 0===e?void 0:e.name)||"Unknown Project"," -"," ",G.clearanceDate?new Date(G.clearanceDate).toLocaleDateString():"Unknown Date"]})]})]}),(0,_.jsx)(d.A,{variant:"contained",color:"secondary",onClick:()=>{ie(null),Te(),se(!0)},startIcon:(0,_.jsx)(B.A,{}),children:"Add Item"})]}),(null===G||void 0===G?void 0:G.airMonitoring)&&(0,_.jsxs)(a.A,{display:"flex",gap:2,sx:{mt:2},alignItems:"center",children:[G.airMonitoringReport&&(0,_.jsx)(l.A,{variant:"body2",color:"error",sx:{fontWeight:"medium"},children:"\u2713 Air Monitoring Report Attached"}),(0,_.jsx)(d.A,{variant:"outlined",color:"primary",onClick:()=>{be(!0),(async()=>{var e;if(null!==G&&void 0!==G&&null!==(e=G.projectId)&&void 0!==e&&e._id)try{Ce(!0);const e=await K.A.getAirMonitoringReports(G.projectId._id);Ie(e)}catch($){console.error("Error fetching air monitoring reports:",$),re({open:!0,message:"Failed to fetch air monitoring reports",severity:"error"})}finally{Ce(!1)}else re({open:!0,message:"No project found for this clearance",severity:"error"})})()},startIcon:(0,_.jsx)(P,{}),children:G.airMonitoringReport?"Replace Air Monitoring Report":"Select Air Monitoring Report"}),G.airMonitoringReport&&(0,_.jsx)(d.A,{variant:"outlined",color:"error",onClick:async()=>{if(window.confirm("Are you sure you want to remove the air monitoring report?"))try{await K.A.update(Y,{airMonitoringReport:null}),re({open:!0,message:"Air monitoring report removed successfully",severity:"success"}),Be()}catch($){console.error("Error removing air monitoring report:",$),re({open:!0,message:"Failed to remove air monitoring report",severity:"error"})}},startIcon:(0,_.jsx)(W.A,{}),children:"Remove Report"})]}),(0,_.jsx)(p.A,{sx:{mt:3},children:(0,_.jsxs)(h.A,{children:[(0,_.jsx)(l.A,{variant:"h6",color:t.grey[100],sx:{mb:2},children:"Job Specific Exclusions"}),(0,_.jsx)(u.A,{fullWidth:!0,label:"Job Specific Exclusions",value:(null===G||void 0===G?void 0:G.jobSpecificExclusions)||"",onChange:e=>{O((t=>(0,o.A)((0,o.A)({},t),{},{jobSpecificExclusions:e.target.value})))},multiline:!0,rows:4,placeholder:"Enter job-specific exclusions that will be added to the Inspection Exclusions section of the report...",helperText:null!==G&&void 0!==G&&G.jobSpecificExclusions&&!Ee?"This text will be appended to the standard Inspection Exclusions section in the clearance report.":Ee?"Saving...":"This text will be appended to the standard Inspection Exclusions section in the clearance report.",InputProps:{endAdornment:Ee?(0,_.jsx)(r.A,{size:20,sx:{mr:1}}):null}}),(0,_.jsx)(a.A,{sx:{mt:2,display:"flex",justifyContent:"flex-end"},children:(0,_.jsx)(d.A,{variant:"contained",color:"primary",onClick:async()=>{try{ze(!0),await K.A.update(Y,{jobSpecificExclusions:(null===G||void 0===G?void 0:G.jobSpecificExclusions)||""}),re({open:!0,message:"Job specific exclusions saved successfully",severity:"success"}),ke(new Date)}catch($){console.error("Error saving job specific exclusions:",$),re({open:!0,message:"Failed to save job specific exclusions",severity:"error"})}finally{ze(!1)}},disabled:Ee,children:Ee?(0,_.jsx)(r.A,{size:24,color:"inherit"}):"Save Exclusions"})}),Me&&(0,_.jsxs)(l.A,{variant:"body2",color:"text.secondary",sx:{mt:1},children:["Last saved: ",(0,J.Yq)(Me)]})]})}),(0,_.jsx)(p.A,{sx:{mt:3},children:(0,_.jsx)(h.A,{children:(0,_.jsx)(m.A,{component:x.A,children:(0,_.jsxs)(A.A,{children:[(0,_.jsx)(g.A,{children:(0,_.jsxs)(j.A,{children:[(0,_.jsx)(y.A,{children:"Location"}),(0,_.jsx)(y.A,{children:"Material Description"}),(0,_.jsx)(y.A,{children:"Asbestos Type"}),(0,_.jsx)(y.A,{children:"Photograph"}),(0,_.jsx)(y.A,{children:"Notes"}),(0,_.jsx)(y.A,{children:"Actions"})]})}),(0,_.jsx)(v.A,{children:(V||[]).map((e=>(0,_.jsxs)(j.A,{children:[(0,_.jsx)(y.A,{children:e.locationDescription}),(0,_.jsx)(y.A,{children:e.materialDescription}),(0,_.jsx)(y.A,{children:(0,_.jsx)(f.A,{label:e.asbestosType,color:_e(e.asbestosType),size:"small"})}),(0,_.jsx)(y.A,{children:e.photograph?(0,_.jsx)(f.A,{label:"Yes",color:"success",size:"small"}):(0,_.jsx)(f.A,{label:"No",color:"default",size:"small"})}),(0,_.jsx)(y.A,{children:e.notes?(0,_.jsx)(l.A,{variant:"body2",noWrap:!0,children:e.notes}):(0,_.jsx)(l.A,{variant:"body2",color:"text.secondary",children:"No notes"})}),(0,_.jsxs)(y.A,{children:[(0,_.jsx)(c.A,{onClick:()=>(e=>{ie(e),ce({locationDescription:e.locationDescription,materialDescription:e.materialDescription,asbestosType:e.asbestosType,photograph:e.photograph||"",notes:e.notes||""}),de(e.photograph||null),he(null),se(!0)})(e),color:"primary",size:"small",title:"Edit",children:(0,_.jsx)(F.A,{})}),(0,_.jsx)(c.A,{onClick:()=>(async e=>{if(window.confirm("Are you sure you want to delete this item?"))try{await K.A.deleteItem(Y,e._id),re({open:!0,message:"Item deleted successfully",severity:"success"}),Be()}catch(t){console.error("Error deleting item:",t),re({open:!0,message:"Failed to delete item",severity:"error"})}})(e),color:"error",size:"small",title:"Delete",children:(0,_.jsx)(W.A,{})})]})]},e._id)))})]})})})}),(0,_.jsxs)(b.A,{open:te,onClose:()=>se(!1),maxWidth:"md",fullWidth:!0,children:[(0,_.jsx)(w.A,{children:oe?"Edit Item":"Add New Item"}),(0,_.jsxs)("form",{onSubmit:async e=>{e.preventDefault();try{const e={locationDescription:ne.locationDescription,materialDescription:ne.materialDescription,asbestosType:ne.asbestosType,photograph:ne.photograph,notes:ne.notes};oe?(await K.A.updateItem(Y,oe._id,e),re({open:!0,message:"Item updated successfully",severity:"success"})):(await K.A.addItem(Y,e),re({open:!0,message:"Item created successfully",severity:"success"})),se(!1),ie(null),Te(),Be()}catch(t){console.error("Error saving item:",t),re({open:!0,message:"Failed to save item",severity:"error"})}},children:[(0,_.jsx)(I.A,{children:(0,_.jsxs)(S.Ay,{container:!0,spacing:2,children:[(0,_.jsx)(S.Ay,{item:!0,xs:12,children:(0,_.jsx)(u.A,{fullWidth:!0,label:"Location Description",value:ne.locationDescription,onChange:e=>ce((0,o.A)((0,o.A)({},ne),{},{locationDescription:e.target.value})),required:!0})}),(0,_.jsx)(S.Ay,{item:!0,xs:12,children:(0,_.jsx)(u.A,{fullWidth:!0,label:"Material Description",value:ne.materialDescription,onChange:e=>ce((0,o.A)((0,o.A)({},ne),{},{materialDescription:e.target.value})),required:!0})}),(0,_.jsx)(S.Ay,{item:!0,xs:12,md:6,children:(0,_.jsxs)(C.A,{fullWidth:!0,required:!0,children:[(0,_.jsx)(D.A,{children:"Asbestos Type"}),(0,_.jsxs)(R.A,{value:ne.asbestosType,onChange:e=>ce((0,o.A)((0,o.A)({},ne),{},{asbestosType:e.target.value})),label:"Asbestos Type",children:[(0,_.jsx)(E.A,{value:"non-friable",children:"Non-friable"}),(0,_.jsx)(E.A,{value:"friable",children:"Friable"})]})]})}),(0,_.jsx)(S.Ay,{item:!0,xs:12,md:6,children:(0,_.jsxs)(a.A,{children:[(0,_.jsx)(l.A,{variant:"subtitle2",gutterBottom:!0,children:"Photograph"}),(0,_.jsxs)(a.A,{sx:{display:"flex",gap:1,mb:2},children:[(0,_.jsx)(d.A,{variant:"outlined",startIcon:(0,_.jsx)(L.A,{}),onClick:()=>{const e=document.createElement("input");e.type="file",e.accept="image/*",e.capture="environment",e.onchange=Pe,e.click()},size:"small",children:"Take Photo"}),(0,_.jsxs)(d.A,{variant:"outlined",startIcon:(0,_.jsx)(U,{}),component:"label",size:"small",children:["Upload Photo",(0,_.jsx)("input",{type:"file",hidden:!0,accept:"image/*",onChange:Pe})]}),le&&(0,_.jsx)(d.A,{variant:"outlined",color:"error",startIcon:(0,_.jsx)(W.A,{}),onClick:()=>{he(null),de(null),ce((0,o.A)((0,o.A)({},ne),{},{photograph:""}))},size:"small",children:"Remove"})]}),le&&(0,_.jsx)(a.A,{sx:{width:200,height:150,borderRadius:1,overflow:"hidden",border:"1px solid #ddd",mb:2},children:(0,_.jsx)("img",{src:le,alt:"Preview",style:{width:"100%",height:"100%",objectFit:"cover"}})}),ue&&(0,_.jsx)(n.A,{severity:ue.type,sx:{mb:2},icon:"processing"===ue.type||"compressing"===ue.type?(0,_.jsx)(r.A,{size:16}):void 0,children:ue.message})]})}),(0,_.jsx)(S.Ay,{item:!0,xs:12,children:(0,_.jsx)(u.A,{fullWidth:!0,label:"Notes",value:ne.notes,onChange:e=>ce((0,o.A)((0,o.A)({},ne),{},{notes:e.target.value})),multiline:!0,rows:3})})]})}),(0,_.jsxs)(z.A,{children:[(0,_.jsx)(d.A,{onClick:()=>se(!1),children:"Cancel"}),(0,_.jsx)(d.A,{type:"submit",variant:"contained",children:oe?"Update":"Create"})]})]})]}),(0,_.jsxs)(b.A,{open:fe,onClose:()=>be(!1),maxWidth:"md",fullWidth:!0,children:[(0,_.jsx)(w.A,{children:"Select Air Monitoring Report"}),(0,_.jsx)(I.A,{children:(0,_.jsxs)(a.A,{sx:{mt:2},children:[(0,_.jsx)(l.A,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Select an air monitoring report from the list below. This will be included in the clearance report as Appendix B."}),Se?(0,_.jsx)(a.A,{display:"flex",justifyContent:"center",alignItems:"center",height:"200px",children:(0,_.jsx)(r.A,{})}):0===we.length?(0,_.jsx)(n.A,{severity:"info",children:"No air monitoring reports found for this project. Reports must be completed and authorized to appear here."}):(0,_.jsx)(a.A,{sx:{maxHeight:400,overflow:"auto"},children:we.map(((e,t)=>(0,_.jsx)(p.A,{sx:{mb:2,cursor:"pointer","&:hover":{backgroundColor:"action.hover"},border:(null===De||void 0===De?void 0:De._id)===e._id?2:1,borderColor:(null===De||void 0===De?void 0:De._id)===e._id?"primary.main":"divider"},onClick:()=>(async e=>{try{Re(e);const{generateShiftReport:t}=await Promise.resolve().then(s.bind(s,94257)),{shiftService:o,jobService:i,sampleService:a,projectService:r,clientService:n}=await Promise.resolve().then(s.bind(s,94505)),c=(await o.getById(e._id)).data,l=(await i.getById(e.jobId)).data,d=(await a.getByShift(e._id)).data||[];let p=l.project;if(p&&"string"===typeof p&&(p=(await r.getById(p)).data),p&&p.client&&"string"===typeof p.client){const e=await n.getById(p.client);p.client=e.data}const h=(await t({shift:c,job:l,samples:d,project:p,returnPdfData:!0})).split(",")[1];await K.A.uploadAirMonitoringReport(Y,{reportData:h}),re({open:!0,message:"Air monitoring report selected and uploaded successfully",severity:"success"}),be(!1),Re(null),Be()}catch($){console.error("Error selecting air monitoring report:",$),re({open:!0,message:"Failed to select air monitoring report",severity:"error"})}})(e),children:(0,_.jsx)(h.A,{sx:{py:2},children:(0,_.jsxs)(a.A,{display:"flex",justifyContent:"space-between",alignItems:"flex-start",children:[(0,_.jsxs)(a.A,{flex:1,children:[(0,_.jsxs)(a.A,{display:"flex",alignItems:"center",gap:1,mb:1,children:[(0,_.jsx)(l.A,{variant:"subtitle1",fontWeight:"medium",children:e.name}),(0,_.jsx)(f.A,{label:e.reportApprovedBy?"Authorized":e.status,color:e.reportApprovedBy?"success":"default",size:"small"})]}),(0,_.jsxs)(l.A,{variant:"body2",color:"text.secondary",mb:.5,children:["Job: ",e.jobName]}),(0,_.jsxs)(l.A,{variant:"body2",color:"text.secondary",children:["Date: ",(0,J.Yq)(e.date),e.reportIssueDate&&" \u2022 Issue Date: ".concat((0,J.Yq)(e.reportIssueDate))]})]}),(null===De||void 0===De?void 0:De._id)===e._id&&(0,_.jsx)(r.A,{size:20})]})})},e._id)))})]})}),(0,_.jsx)(z.A,{children:(0,_.jsx)(d.A,{onClick:()=>be(!1),children:"Cancel"})})]}),(0,_.jsx)(M.A,{open:ae.open,autoHideDuration:6e3,onClose:()=>re((0,o.A)((0,o.A)({},ae),{},{open:!1})),children:(0,_.jsx)(n.A,{onClose:()=>re((0,o.A)((0,o.A)({},ae),{},{open:!1})),severity:ae.severity,children:ae.message})})]})})}},45360:(e,t,s)=>{s.d(t,{A:()=>r});var o=s(89379),i=s(82431);const a="/asbestos-clearances",r={getAll:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(await i.A.get(a,{params:e})).data},getById:async e=>(await i.A.get("".concat(a,"/").concat(e))).data,create:async e=>(await i.A.post(a,e)).data,update:async(e,t)=>(await i.A.put("".concat(a,"/").concat(e),t)).data,delete:async e=>(await i.A.delete("".concat(a,"/").concat(e))).data,updateStatus:async(e,t)=>(await i.A.patch("".concat(a,"/").concat(e,"/status"),{status:t})).data,getStats:async()=>(await i.A.get("".concat(a,"/stats/overview"))).data,search:async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const s=(0,o.A)({search:e},t);return(await i.A.get(a,{params:s})).data},getByStatus:async e=>(await i.A.get(a,{params:{status:e}})).data,getByRemovalist:async e=>(await i.A.get(a,{params:{asbestosRemovalist:e}})).data,uploadAirMonitoringReport:async(e,t)=>(await i.A.post("".concat(a,"/").concat(e,"/air-monitoring-report"),t)).data,getItems:async e=>(await i.A.get("".concat(a,"/").concat(e,"/items"))).data,addItem:async(e,t)=>(await i.A.post("".concat(a,"/").concat(e,"/items"),t)).data,updateItem:async(e,t,s)=>(await i.A.put("".concat(a,"/").concat(e,"/items/").concat(t),s)).data,deleteItem:async(e,t)=>(await i.A.delete("".concat(a,"/").concat(e,"/items/").concat(t))).data,getAirMonitoringReports:async e=>(await i.A.get("".concat(a,"/air-monitoring-reports/").concat(e))).data}},72429:(e,t,s)=>{s.d(t,{A:()=>a});var o=s(59662),i=s(70579);const a=(0,o.A)([(0,i.jsx)("circle",{cx:"12",cy:"12",r:"3.2"},"0"),(0,i.jsx)("path",{d:"M9 2 7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5"},"1")],"PhotoCamera")}}]);
//# sourceMappingURL=974.16145b68.chunk.js.map