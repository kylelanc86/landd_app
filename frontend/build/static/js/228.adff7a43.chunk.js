"use strict";(self.webpackChunkair_monitoring_frontend=self.webpackChunkair_monitoring_frontend||[]).push([[228],{43228:(e,t,a)=>{a.r(t),a.d(t,{default:()=>V});var n=a(89379),o=a(65043),s=a(96446),r=a(81637),i=a(67254),c=a(85865),l=a(11906),d=a(12110),A=a(26494),u=a(79650),p=a(63336),g=a(71806),m=a(84882),h=a(28076),j=a(10039),x=a(73460),y=a(43845),f=a(17392),v=a(90035),b=a(26600),S=a(35316),w=a(68903),C=a(53193),P=a(79190),D=a(72221),I=a(32143),T=a(15795),R=a(74605),F=a(51962),k=a(29347),L=a(73158),M=a(73216),E=a(22505),N=a(95540),_=a(63471),z=a(3044),U=a(47260),W=(a(37660),a(63777)),O=a(94505),G=a(45360),q=a(88027),B=a(43381),H=a(70579);const J=["AGH","Aztech Services","Capstone","Crown Asbestos Removals","Empire Contracting","Glade Group","IAR","Jesco","Ozbestos","Spec Services"],V=()=>{const e=W.LU,t=(0,M.Zp)(),[a,V]=(0,o.useState)([]),[Z,K]=(0,o.useState)([]),[Y,$]=(0,o.useState)([]),[Q,X]=(0,o.useState)(!0),[ee,te]=(0,o.useState)(null),[ae,ne]=(0,o.useState)(!1),[oe,se]=(0,o.useState)(null),[re,ie]=(0,o.useState)(!1),[ce,le]=(0,o.useState)({open:!1,message:"",severity:"success"}),[de,Ae]=(0,o.useState)({projectId:"",clearanceDate:"",clearanceType:"Non-friable",LAA:"",asbestosRemovalist:"",airMonitoring:!1,airMonitoringReport:null,jobSpecificExclusions:"",notes:""});(0,o.useEffect)((()=>{ue()}),[]);const ue=async()=>{try{X(!0);const[e,t,a]=await Promise.all([G.A.getAll(),O.projectService.getAll({limit:1e3,status:"Assigned,In progress,Samples submitted,Lab Analysis Complete,Report sent for review,Ready for invoicing,Invoice sent"}),O.Dv.getAll()]);console.log("Clearances API response:",e),console.log("Projects API response:",t),console.log("Projects API response type:",typeof t),console.log("Projects API response keys:",t?Object.keys(t):"null/undefined"),console.log("Users API response:",a),V(e.clearances||e.data||e||[]);let n=[];t&&(t.data&&Array.isArray(t.data)?n=t.data:Array.isArray(t)?n=t:t.data&&t.data.data&&Array.isArray(t.data.data)&&(n=t.data.data)),console.log("Projects array:",n),console.log("Projects array length:",n.length),console.log("First project (if any):",n[0]),K(n);const o=(a.data||a).filter((e=>e.isActive));$(o)}catch(e){console.error("Error fetching data:",e),te("Failed to load data")}finally{X(!1)}},pe=()=>{Ae({projectId:"",clearanceDate:"",clearanceType:"Non-friable",LAA:"",asbestosRemovalist:"",airMonitoring:!1,airMonitoringReport:null,jobSpecificExclusions:"",notes:""})},ge=e=>{switch(e){case"complete":return"success";case"in progress":return"warning";case"Site Work Complete":return"info";default:return"default"}},me=e=>{if(!Array.isArray(Z))return console.warn("Projects is not an array:",Z),"Unknown Project";const t=(null===e||void 0===e?void 0:e._id)||e,a=Z.find((e=>e._id===t));return a?a.projectID:"Unknown Project"},he=e=>{if(!Array.isArray(Z))return console.warn("Projects is not an array:",Z),"Unknown Project";const t=(null===e||void 0===e?void 0:e._id)||e,a=Z.find((e=>e._id===t));return a?a.name:"Unknown Project"};return Q?(0,H.jsx)(s.A,{display:"flex",justifyContent:"center",alignItems:"center",height:"400px",children:(0,H.jsx)(r.A,{})}):ee?(0,H.jsx)(s.A,{m:"20px",children:(0,H.jsx)(i.A,{severity:"error",children:ee})}):(0,H.jsx)(q.A,{requiredPermissions:["asbestos.view"],children:(0,H.jsxs)(s.A,{m:"20px",children:[(0,H.jsxs)(s.A,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[(0,H.jsx)(c.A,{variant:"h4",color:e.grey[500],fontWeight:"bold",sx:{mb:"5px"},children:"Asbestos Clearances"}),(0,H.jsx)(l.A,{variant:"contained",color:"secondary",onClick:()=>{se(null),pe(),ne(!0)},startIcon:(0,H.jsx)(E.A,{}),children:"Add Clearance"})]}),(0,H.jsx)(d.A,{sx:{mt:3},children:(0,H.jsx)(A.A,{children:Q?(0,H.jsx)(s.A,{display:"flex",justifyContent:"center",alignItems:"center",height:"200px",children:(0,H.jsx)(r.A,{})}):(0,H.jsx)(u.A,{component:p.A,children:(0,H.jsxs)(g.A,{children:[(0,H.jsx)(m.A,{children:(0,H.jsxs)(h.A,{children:[(0,H.jsx)(j.A,{children:"Project ID"}),(0,H.jsx)(j.A,{children:"Clearance Date"}),(0,H.jsx)(j.A,{children:"Project Name"}),(0,H.jsx)(j.A,{children:"Type"}),(0,H.jsx)(j.A,{children:"Air Monitoring"}),(0,H.jsx)(j.A,{children:"Status"}),(0,H.jsx)(j.A,{children:"Actions"})]})}),(0,H.jsx)(x.A,{children:Array.isArray(a)&&(a||[]).map((e=>(0,H.jsxs)(h.A,{children:[(0,H.jsx)(j.A,{children:me(e.projectId)}),(0,H.jsx)(j.A,{children:e.clearanceDate?new Date(e.clearanceDate).toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"}):"N/A"}),(0,H.jsx)(j.A,{children:he(e.projectId)}),(0,H.jsx)(j.A,{children:e.clearanceType}),(0,H.jsx)(j.A,{children:(0,H.jsx)(y.A,{label:e.airMonitoring?"Yes":"No",color:e.airMonitoring?"success":"default",size:"small"})}),(0,H.jsx)(j.A,{children:(0,H.jsx)(y.A,{label:e.status,color:ge(e.status),size:"small"})}),(0,H.jsxs)(j.A,{children:[(0,H.jsx)(f.A,{onClick:()=>(e=>{t("/clearances/".concat(e._id,"/items"))})(e),color:"info",size:"small",title:"View Items",children:(0,H.jsx)(U.A,{})}),(0,H.jsx)(f.A,{onClick:()=>(e=>{se(e),Ae({projectId:e.projectId._id||e.projectId,clearanceDate:e.clearanceDate?new Date(e.clearanceDate).toISOString().split("T")[0]:"",clearanceType:e.clearanceType,LAA:e.LAA,asbestosRemovalist:e.asbestosRemovalist,airMonitoring:e.airMonitoring||!1,airMonitoringReport:e.airMonitoringReport||null,jobSpecificExclusions:e.jobSpecificExclusions||"",notes:e.notes||""}),ne(!0)})(e),color:"primary",size:"small",title:"Edit",children:(0,H.jsx)(N.A,{})}),(0,H.jsx)(f.A,{onClick:()=>(async e=>{try{console.log("handleGeneratePDF called with clearance:",e),ie(!0),console.log("Fetching full clearance data...");const t=await G.A.getById(e._id);console.log("Full clearance data:",t),console.log("Calling generateHTMLTemplatePDF...");const a=await(0,B.generateHTMLTemplatePDF)("asbestos-clearance",t);console.log("PDF generation completed, fileName:",a),le({open:!0,message:"PDF generated successfully: ".concat(a),severity:"success"})}catch(t){console.error("Error generating PDF:",t),le({open:!0,message:"Failed to generate PDF",severity:"error"})}finally{console.log("Setting generatingPDF to false"),ie(!1)}})(e),color:"secondary",size:"small",disabled:re,title:"Generate PDF",children:(0,H.jsx)(z.A,{})}),(0,H.jsx)(f.A,{onClick:()=>(async e=>{if(window.confirm("Are you sure you want to delete this clearance?"))try{await G.A.delete(e._id),le({open:!0,message:"Clearance deleted successfully",severity:"success"}),ue()}catch(t){console.error("Error deleting clearance:",t),le({open:!0,message:"Failed to delete clearance",severity:"error"})}})(e),color:"error",size:"small",title:"Delete",children:(0,H.jsx)(_.A,{})})]})]},e._id)))})]})})})}),(0,H.jsxs)(v.A,{open:ae,onClose:()=>ne(!1),maxWidth:"md",fullWidth:!0,children:[(0,H.jsx)(b.A,{children:oe?"Edit Clearance":"Add New Clearance"}),(0,H.jsxs)("form",{onSubmit:async e=>{e.preventDefault();try{oe?(await G.A.update(oe._id,de),le({open:!0,message:"Clearance updated successfully",severity:"success"})):(await G.A.create(de),le({open:!0,message:"Clearance created successfully",severity:"success"})),ne(!1),se(null),pe(),ue()}catch(t){console.error("Error saving clearance:",t),le({open:!0,message:"Failed to save clearance",severity:"error"})}},children:[(0,H.jsx)(S.A,{children:(0,H.jsxs)(w.Ay,{container:!0,spacing:2,children:[(0,H.jsx)(w.Ay,{item:!0,xs:12,children:(0,H.jsxs)(C.A,{fullWidth:!0,required:!0,children:[(0,H.jsx)(P.A,{children:"Project"}),(0,H.jsx)(D.A,{value:de.projectId,onChange:e=>Ae((0,n.A)((0,n.A)({},de),{},{projectId:e.target.value})),label:"Project",children:(Z||[]).length>0?(Z||[]).map((e=>(0,H.jsxs)(I.A,{value:e._id,children:[e.projectID,": ",e.name]},e._id))):(0,H.jsx)(I.A,{disabled:!0,children:"No projects available"})})]})}),(0,H.jsx)(w.Ay,{item:!0,xs:12,md:6,children:(0,H.jsx)(T.A,{fullWidth:!0,type:"date",label:"Clearance Date",value:de.clearanceDate,onChange:e=>Ae((0,n.A)((0,n.A)({},de),{},{clearanceDate:e.target.value})),required:!0,InputLabelProps:{shrink:!0}})}),(0,H.jsx)(w.Ay,{item:!0,xs:12,md:6,children:(0,H.jsxs)(C.A,{fullWidth:!0,required:!0,children:[(0,H.jsx)(P.A,{children:"Clearance Type"}),(0,H.jsxs)(D.A,{value:de.clearanceType,onChange:e=>Ae((0,n.A)((0,n.A)({},de),{},{clearanceType:e.target.value})),label:"Clearance Type",children:[(0,H.jsx)(I.A,{value:"Non-friable",children:"Non-friable"}),(0,H.jsx)(I.A,{value:"Friable",children:"Friable"})]})]})}),(0,H.jsx)(w.Ay,{item:!0,xs:12,md:6,children:(0,H.jsxs)(C.A,{fullWidth:!0,required:!0,children:[(0,H.jsx)(P.A,{children:"LAA"}),(0,H.jsx)(D.A,{value:de.LAA,onChange:e=>Ae((0,n.A)((0,n.A)({},de),{},{LAA:e.target.value})),label:"LAA",children:(Y||[]).map((e=>(0,H.jsxs)(I.A,{value:"".concat(e.firstName," ").concat(e.lastName),children:[e.firstName," ",e.lastName]},e._id)))})]})}),(0,H.jsx)(w.Ay,{item:!0,xs:12,md:6,children:(0,H.jsxs)(C.A,{fullWidth:!0,required:!0,children:[(0,H.jsx)(P.A,{children:"Asbestos Removalist"}),(0,H.jsx)(D.A,{value:de.asbestosRemovalist,onChange:e=>Ae((0,n.A)((0,n.A)({},de),{},{asbestosRemovalist:e.target.value})),label:"Asbestos Removalist",children:J.map((e=>(0,H.jsx)(I.A,{value:e,children:e},e)))})]})}),(0,H.jsx)(w.Ay,{item:!0,xs:12,children:(0,H.jsx)(R.A,{control:(0,H.jsx)(F.A,{checked:de.airMonitoring,onChange:e=>Ae((0,n.A)((0,n.A)({},de),{},{airMonitoring:e.target.checked})),color:"primary"}),label:"Include Air Monitoring Report"})}),de.airMonitoring&&(0,H.jsxs)(w.Ay,{item:!0,xs:12,children:[(0,H.jsx)("input",{accept:".pdf",style:{display:"none"},id:"air-monitoring-report-upload",type:"file",onChange:e=>{const t=e.target.files[0];if(t){const e=new FileReader;e.onload=e=>{const t=e.target.result.split(",")[1];Ae((0,n.A)((0,n.A)({},de),{},{airMonitoringReport:t}))},e.readAsDataURL(t)}}}),(0,H.jsx)("label",{htmlFor:"air-monitoring-report-upload",children:(0,H.jsx)(l.A,{variant:"outlined",component:"span",startIcon:(0,H.jsx)(z.A,{}),children:"Upload Air Monitoring Report (PDF)"})}),de.airMonitoringReport&&(0,H.jsx)(c.A,{variant:"body2",color:"success.main",sx:{mt:1},children:"\u2713 Report uploaded successfully"})]}),(0,H.jsx)(w.Ay,{item:!0,xs:12,children:(0,H.jsx)(T.A,{fullWidth:!0,label:"Job Specific Exclusions",value:de.jobSpecificExclusions,onChange:e=>Ae((0,n.A)((0,n.A)({},de),{},{jobSpecificExclusions:e.target.value})),multiline:!0,rows:3})}),(0,H.jsx)(w.Ay,{item:!0,xs:12,children:(0,H.jsx)(T.A,{fullWidth:!0,label:"Notes",value:de.notes,onChange:e=>Ae((0,n.A)((0,n.A)({},de),{},{notes:e.target.value})),multiline:!0,rows:3})})]})}),(0,H.jsxs)(k.A,{children:[(0,H.jsx)(l.A,{onClick:()=>ne(!1),children:"Cancel"}),(0,H.jsx)(l.A,{type:"submit",variant:"contained",children:oe?"Update":"Create"})]})]})]}),(0,H.jsx)(L.A,{open:ce.open,autoHideDuration:6e3,onClose:()=>le((0,n.A)((0,n.A)({},ce),{},{open:!1})),children:(0,H.jsx)(i.A,{onClose:()=>le((0,n.A)((0,n.A)({},ce),{},{open:!1})),severity:ce.severity,children:ce.message})})]})})}},43381:(e,t,a)=>{a.r(t),a.d(t,{generateHTMLPDF:()=>s,generateHTMLTemplatePDF:()=>r,generateTemplatePDF:()=>o});var n=a(37762);a(65239);const o=async(e,t,a)=>{const o=new n.default,s=o.internal.pageSize.getWidth(),r=o.internal.pageSize.getHeight(),i=20,c=s-40;let l=i;const d=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:11,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"normal",n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:8;if(!e)return l;o.setFontSize(t),o.setFont("helvetica",a);const s=o.splitTextToSize(e,c);return o.text(e,i,l,{maxWidth:c}),l+=s.length*t*1.2+n,l},A=function(e){return d(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:14,arguments.length>2&&void 0!==arguments[2]?arguments[2]:"bold",12)};l=A(a(e.standardSections.frontCoverTitle||"Non-friable Asbestos Removal Clearance"),16,"bold"),l=d(a(e.standardSections.frontCoverSubtitle||""),12,"normal",20),l+=10,e.companyDetails&&(l=A("Company Details",12,"bold"),Object.entries(e.companyDetails).forEach((e=>{let[t,a]=e;const n=t.charAt(0).toUpperCase()+t.slice(1).replace(/([A-Z])/g," $1");l=d("".concat(n,": ").concat(a),10,"normal",4)})),l+=10),l=A(a(e.standardSections.inspectionDetailsTitle||"Inspection Details"),12,"bold"),l=d(a(e.standardSections.inspectionIntroduction||""),10,"normal",8),l=d(a(e.standardSections.inspectionSpecifics||""),10,"normal",8),l=d(a(e.standardSections.tableIntroduction||""),10,"normal",8),l=d("Sample Inspection Results:",10,"bold",4);[["Area","Material Type","Condition","Result"],["Kitchen","Vinyl Floor Tiles","Good","Pass"],["Bathroom","Vinyl Floor Tiles","Good","Pass"],["Living Room","Vinyl Floor Tiles","Good","Pass"]].forEach(((e,t)=>{const a=0===t,n=a?"bold":"normal",s=a?10:9,r=[40,50,40,30];let c=i;e.forEach(((e,t)=>{o.setFontSize(s),o.setFont("helvetica",n),o.text(e,c,l,{maxWidth:r[t]}),c+=r[t]+5})),l+=1.2*s+2})),l+=10,l>r-100&&(o.addPage(),l=i),l=A(a(e.standardSections.clearanceCertificationTitle||"Clearance Certification"),12,"bold"),l=d(a(e.standardSections.clearanceCertificationText||""),10,"normal",8),l=d(a(e.standardSections.riskAssessmentText||""),10,"normal",8),l=d(a(e.standardSections.contactText||""),10,"normal",8),l=d(a(e.standardSections.behalfText||""),10,"normal",8),l=d(a(e.standardSections.signatureTitle||""),10,"bold",8),l>r-100&&(o.addPage(),l=i),l=A(a(e.standardSections.backgroundTitle||"Background Information"),12,"bold"),l=d(a(e.standardSections.backgroundIntroduction||""),10,"normal",8),l=d("\u2022 ".concat(a(e.standardSections.bulletPoint1||"")),10,"normal",4),l=d("\u2022 ".concat(a(e.standardSections.bulletPoint2||"")),10,"normal",4),l=d(a(e.standardSections.requirementsText||""),10,"normal",8),l=d("\u2022 ".concat(a(e.standardSections.bulletPoint3||"")),10,"normal",4),l=d("\u2022 ".concat(a(e.standardSections.bulletPoint4||"")),10,"normal",4),l=d("\u2022 ".concat(a(e.standardSections.bulletPoint5||"")),10,"normal",4),l>r-100&&(o.addPage(),l=i),l=A(a(e.standardSections.legislativeTitle||"Legislative Requirements"),12,"bold"),l=d(a(e.standardSections.legislativeIntroduction||""),10,"normal",8),l=d("\u2022 ".concat(a(e.standardSections.legislativePoint1||"")),10,"normal",4),l=d("\u2022 ".concat(a(e.standardSections.legislativePoint2||"")),10,"normal",4),l=d("\u2022 ".concat(a(e.standardSections.legislativePoint3||"")),10,"normal",4),l=A(a(e.standardSections.limitationsTitle||"Limitations"),12,"bold"),l=d(a(e.standardSections.limitationsText||""),10,"normal",8),l>r-150&&(o.addPage(),l=i),l=A("Authorised Signature",12,"bold"),l+=20,o.setLineWidth(.5),o.line(i,l,100,l),l+=5,l=d("Name: John Smith",10,"normal",4),l=d("License: AI000456",10,"normal",4),l=d("Date: 25 July 2024",10,"normal",4),l+=20,l=d(a(e.standardSections.footerText||""),9,"normal",8);const u="asbestos-clearance-template-preview-".concat((new Date).toISOString().split("T")[0],".pdf");return o.save(u),u},s=async(e,t)=>r(e,t),r=async(e,t)=>{try{var a;console.log("Starting server-side PDF generation with data:",t);const e="".concat("https://landd-app-backend1.onrender.com/api","/pdf/generate-asbestos-clearance?t=").concat(Date.now());console.log("Calling backend URL:",e);const n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(localStorage.getItem("token")),"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},body:JSON.stringify({clearanceData:t})});if(console.log("Response status:",n.status),console.log("Response headers:",Object.fromEntries(n.headers.entries())),!n.ok){const e=await n.json();throw new Error(e.error||"Failed to generate PDF")}const o=await n.blob();console.log("PDF blob size:",o.size,"bytes");const s=window.URL.createObjectURL(o),r=document.createElement("a");r.href=s;const i="asbestos-clearance-".concat((null===(a=t.projectId)||void 0===a?void 0:a.name)||"report","-").concat((new Date).toISOString().split("T")[0],".pdf");return r.download=i,document.body.appendChild(r),r.click(),document.body.removeChild(r),window.URL.revokeObjectURL(s),console.log("PDF generation completed successfully:",i),i}catch(n){throw console.error("Error generating HTML template PDF:",n),console.error("Error stack:",n.stack),n}}},45360:(e,t,a)=>{a.d(t,{A:()=>r});var n=a(89379),o=a(82431);const s="/asbestos-clearances",r={getAll:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(await o.A.get(s,{params:e})).data},getById:async e=>(await o.A.get("".concat(s,"/").concat(e))).data,create:async e=>(await o.A.post(s,e)).data,update:async(e,t)=>(await o.A.put("".concat(s,"/").concat(e),t)).data,delete:async e=>(await o.A.delete("".concat(s,"/").concat(e))).data,updateStatus:async(e,t)=>(await o.A.patch("".concat(s,"/").concat(e,"/status"),{status:t})).data,getStats:async()=>(await o.A.get("".concat(s,"/stats/overview"))).data,search:async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const a=(0,n.A)({search:e},t);return(await o.A.get(s,{params:a})).data},getByStatus:async e=>(await o.A.get(s,{params:{status:e}})).data,getByRemovalist:async e=>(await o.A.get(s,{params:{asbestosRemovalist:e}})).data,uploadAirMonitoringReport:async(e,t)=>(await o.A.post("".concat(s,"/").concat(e,"/air-monitoring-report"),t)).data,getItems:async e=>(await o.A.get("".concat(s,"/").concat(e,"/items"))).data,addItem:async(e,t)=>(await o.A.post("".concat(s,"/").concat(e,"/items"),t)).data,updateItem:async(e,t,a)=>(await o.A.put("".concat(s,"/").concat(e,"/items/").concat(t),a)).data,deleteItem:async(e,t)=>(await o.A.delete("".concat(s,"/").concat(e,"/items/").concat(t))).data,getAirMonitoringReports:async e=>(await o.A.get("".concat(s,"/air-monitoring-reports/").concat(e))).data}}}]);
//# sourceMappingURL=228.adff7a43.chunk.js.map