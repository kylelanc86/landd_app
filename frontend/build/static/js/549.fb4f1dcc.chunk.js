"use strict";(self.webpackChunkair_monitoring_frontend=self.webpackChunkair_monitoring_frontend||[]).push([[549],{3632:(t,e,a)=>{a.d(e,{A:()=>r});var o=a(59662),n=a(70579);const r=(0,o.A)((0,n.jsx)("path",{d:"M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5M12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5m0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"}),"Visibility")},30513:(t,e,a)=>{a.d(e,{A:()=>r});var o=a(59662),n=a(70579);const r=(0,o.A)((0,n.jsx)("path",{d:"M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3m-3 11H8v-5h8zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1m-1-9H6v4h12z"}),"Print")},32058:(t,e,a)=>{a.d(e,{A:()=>r});var o=a(82431);const n="/asbestos-clearance-reports",r={getAll:async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(await o.A.get(n,{params:t})).data},getByClearanceId:async t=>(await o.A.get("".concat(n,"/clearance/").concat(t))).data,getById:async t=>(await o.A.get("".concat(n,"/").concat(t))).data,create:async t=>(await o.A.post(n,t)).data,update:async(t,e)=>(await o.A.put("".concat(n,"/").concat(t),e)).data,delete:async t=>(await o.A.delete("".concat(n,"/").concat(t))).data}},43381:(t,e,a)=>{a.r(e),a.d(e,{generateHTMLPDF:()=>r,generateHTMLTemplatePDF:()=>s,generateTemplatePDF:()=>n});var o=a(37762);a(65239);const n=async(t,e,a)=>{const n=new o.default,r=n.internal.pageSize.getWidth(),s=n.internal.pageSize.getHeight(),c=20,i=r-40;let l=c;const d=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:11,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"normal",o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:8;if(!t)return l;n.setFontSize(e),n.setFont("helvetica",a);const r=n.splitTextToSize(t,i);return n.text(t,c,l,{maxWidth:i}),l+=r.length*e*1.2+o,l},p=function(t){return d(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:14,arguments.length>2&&void 0!==arguments[2]?arguments[2]:"bold",12)};l=p(a(t.standardSections.frontCoverTitle||"Non-friable Asbestos Removal Clearance"),16,"bold"),l=d(a(t.standardSections.frontCoverSubtitle||""),12,"normal",20),l+=10,t.companyDetails&&(l=p("Company Details",12,"bold"),Object.entries(t.companyDetails).forEach((t=>{let[e,a]=t;const o=e.charAt(0).toUpperCase()+e.slice(1).replace(/([A-Z])/g," $1");l=d("".concat(o,": ").concat(a),10,"normal",4)})),l+=10),l=p(a(t.standardSections.inspectionDetailsTitle||"Inspection Details"),12,"bold"),l=d(a(t.standardSections.inspectionIntroduction||""),10,"normal",8),l=d(a(t.standardSections.inspectionSpecifics||""),10,"normal",8),l=d(a(t.standardSections.tableIntroduction||""),10,"normal",8),l=d("Sample Inspection Results:",10,"bold",4);[["Area","Material Type","Condition","Result"],["Kitchen","Vinyl Floor Tiles","Good","Pass"],["Bathroom","Vinyl Floor Tiles","Good","Pass"],["Living Room","Vinyl Floor Tiles","Good","Pass"]].forEach(((t,e)=>{const a=0===e,o=a?"bold":"normal",r=a?10:9,s=[40,50,40,30];let i=c;t.forEach(((t,e)=>{n.setFontSize(r),n.setFont("helvetica",o),n.text(t,i,l,{maxWidth:s[e]}),i+=s[e]+5})),l+=1.2*r+2})),l+=10,l>s-100&&(n.addPage(),l=c),l=p(a(t.standardSections.clearanceCertificationTitle||"Clearance Certification"),12,"bold"),l=d(a(t.standardSections.clearanceCertificationText||""),10,"normal",8),l=d(a(t.standardSections.riskAssessmentText||""),10,"normal",8),l=d(a(t.standardSections.contactText||""),10,"normal",8),l=d(a(t.standardSections.behalfText||""),10,"normal",8),l=d(a(t.standardSections.signatureTitle||""),10,"bold",8),l>s-100&&(n.addPage(),l=c),l=p(a(t.standardSections.backgroundTitle||"Background Information"),12,"bold"),l=d(a(t.standardSections.backgroundIntroduction||""),10,"normal",8),l=d("\u2022 ".concat(a(t.standardSections.bulletPoint1||"")),10,"normal",4),l=d("\u2022 ".concat(a(t.standardSections.bulletPoint2||"")),10,"normal",4),l=d(a(t.standardSections.requirementsText||""),10,"normal",8),l=d("\u2022 ".concat(a(t.standardSections.bulletPoint3||"")),10,"normal",4),l=d("\u2022 ".concat(a(t.standardSections.bulletPoint4||"")),10,"normal",4),l=d("\u2022 ".concat(a(t.standardSections.bulletPoint5||"")),10,"normal",4),l>s-100&&(n.addPage(),l=c),l=p(a(t.standardSections.legislativeTitle||"Legislative Requirements"),12,"bold"),l=d(a(t.standardSections.legislativeIntroduction||""),10,"normal",8),l=d("\u2022 ".concat(a(t.standardSections.legislativePoint1||"")),10,"normal",4),l=d("\u2022 ".concat(a(t.standardSections.legislativePoint2||"")),10,"normal",4),l=d("\u2022 ".concat(a(t.standardSections.legislativePoint3||"")),10,"normal",4),l=p(a(t.standardSections.limitationsTitle||"Limitations"),12,"bold"),l=d(a(t.standardSections.limitationsText||""),10,"normal",8),l>s-150&&(n.addPage(),l=c),l=p("Authorised Signature",12,"bold"),l+=20,n.setLineWidth(.5),n.line(c,l,100,l),l+=5,l=d("Name: John Smith",10,"normal",4),l=d("License: AI000456",10,"normal",4),l=d("Date: 25 July 2024",10,"normal",4),l+=20,l=d(a(t.standardSections.footerText||""),9,"normal",8);const g="asbestos-clearance-template-preview-".concat((new Date).toISOString().split("T")[0],".pdf");return n.save(g),g},r=async(t,e)=>s(t,e),s=async(t,e)=>{try{var a;console.log("Starting server-side PDF generation with data:",e);const t="".concat("https://landd-app-backend1.onrender.com/api","/pdf/generate-asbestos-clearance?t=").concat(Date.now());console.log("Calling backend URL:",t);const o=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(localStorage.getItem("token")),"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},body:JSON.stringify({clearanceData:e})});if(console.log("Response status:",o.status),console.log("Response headers:",Object.fromEntries(o.headers.entries())),!o.ok){const t=await o.json();throw new Error(t.error||"Failed to generate PDF")}const n=await o.blob();console.log("PDF blob size:",n.size,"bytes");const r=window.URL.createObjectURL(n),s=document.createElement("a");s.href=r;const c="asbestos-clearance-".concat((null===(a=e.projectId)||void 0===a?void 0:a.name)||"report","-").concat((new Date).toISOString().split("T")[0],".pdf");return s.download=c,document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(r),console.log("PDF generation completed successfully:",c),c}catch(o){throw console.error("Error generating HTML template PDF:",o),console.error("Error stack:",o.stack),o}}},45360:(t,e,a)=>{a.d(e,{A:()=>s});var o=a(89379),n=a(82431);const r="/asbestos-clearances",s={getAll:async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(await n.A.get(r,{params:t})).data},getById:async t=>(await n.A.get("".concat(r,"/").concat(t))).data,create:async t=>(await n.A.post(r,t)).data,update:async(t,e)=>(await n.A.put("".concat(r,"/").concat(t),e)).data,delete:async t=>(await n.A.delete("".concat(r,"/").concat(t))).data,updateStatus:async(t,e)=>(await n.A.patch("".concat(r,"/").concat(t,"/status"),{status:e})).data,getStats:async()=>(await n.A.get("".concat(r,"/stats/overview"))).data,search:async function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const a=(0,o.A)({search:t},e);return(await n.A.get(r,{params:a})).data},getByStatus:async t=>(await n.A.get(r,{params:{status:t}})).data,getByRemovalist:async t=>(await n.A.get(r,{params:{asbestosRemovalist:t}})).data,uploadAirMonitoringReport:async(t,e)=>(await n.A.post("".concat(r,"/").concat(t,"/air-monitoring-report"),e)).data,getItems:async t=>(await n.A.get("".concat(r,"/").concat(t,"/items"))).data,addItem:async(t,e)=>(await n.A.post("".concat(r,"/").concat(t,"/items"),e)).data,updateItem:async(t,e,a)=>(await n.A.put("".concat(r,"/").concat(t,"/items/").concat(e),a)).data,deleteItem:async(t,e)=>(await n.A.delete("".concat(r,"/").concat(t,"/items/").concat(e))).data,getAirMonitoringReports:async t=>(await n.A.get("".concat(r,"/air-monitoring-reports/").concat(t))).data}},47968:(t,e,a)=>{a.d(e,{A:()=>r});var o=a(59662),n=a(70579);const r=(0,o.A)((0,n.jsx)("path",{d:"M5 20h14v-2H5zM19 9h-4V3H9v6H5l7 7z"}),"Download")},76961:(t,e,a)=>{a.d(e,{A:()=>n});var o=a(82431);const n={getAll:async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(await o.A.get("/projects",{params:t})).data},getById:t=>o.A.get("/projects/".concat(t)),create:t=>o.A.post("/projects",t),update:(t,e)=>o.A.put("/projects/".concat(t),e),delete:t=>o.A.delete("/projects/".concat(t))}},96549:(t,e,a)=>{a.r(e),a.d(e,{default:()=>C});var o=a(65043),n=a(73216),r=a(96446),s=a(81637),c=a(85865),i=a(67254),l=a(17392),d=a(63336),p=a(79650),g=a(71806),h=a(84882),m=a(28076),y=a(10039),u=a(73460),A=a(43845),f=a(77739),j=a(87332),v=a(3632),b=a(47968),w=a(30513),x=a(26240),S=a(63777),I=a(76961),T=a(32058);a(45360),a(82431);var R=a(94505),P=a(94257),B=a(70579);const C=()=>{(0,x.A)();const t=S.LU,{projectId:e}=(0,n.g)(),C=(0,n.Zp)(),[D,_]=(0,o.useState)(null),[F,k]=(0,o.useState)([]),[L,N]=(0,o.useState)(!0),[z,E]=(0,o.useState)("");(0,o.useEffect)((()=>{M()}),[e]);const M=async()=>{try{N(!0),E("");const o=await I.A.getById(e);_(o.data);const n=[];try{console.log("Fetching clearance reports for project:",e);const t=await T.A.getAll({projectId:e});if(console.log("Clearance reports response:",t),t.reports){console.log("Number of clearance reports found:",t.reports.length);const e={};t.reports.forEach((t=>{var a;const o=(null===(a=t.clearanceId)||void 0===a?void 0:a._id)||t.clearanceId;var n,r;e[o]||(e[o]={id:o,date:new Date((null===(n=t.clearanceId)||void 0===n?void 0:n.clearanceDate)||t.createdAt),type:"Asbestos Clearance Report",status:(null===(r=t.clearanceId)||void 0===r?void 0:r.status)||"Unknown",report:t,category:"clearance"})})),Object.values(e).forEach((t=>{console.log("Adding clearance report:",t.id,t.status),n.push(t)}))}}catch(a){console.log("No clearance reports found for this project:",a)}if(0===n.length)try{var t;console.log("No clearance reports found, fetching air monitoring reports for project:",e);const o=await R.jobService.getAll();console.log("All jobs response:",o);const r=(null===(t=o.data)||void 0===t?void 0:t.filter((t=>{var a;return t.project===e||(null===(a=t.project)||void 0===a?void 0:a._id)===e})))||[];console.log("Project jobs found:",r.length);for(const t of r)try{console.log("Fetching shifts for job:",t._id,t.name);const e=(await R.shiftService.getByJob(t._id)).data||[];console.log("Shifts found for job:",t.name,e.length),e.forEach((e=>{console.log("Checking shift:",e._id,e.name,"status:",e.status),("analysis_complete"===e.status||"shift_complete"===e.status||e.reportApprovedBy)&&(console.log("Adding air monitoring report for shift:",e._id),n.push({id:e._id,date:new Date(e.reportIssueDate||e.updatedAt||e.createdAt),type:"Air Monitoring Report",status:e.reportApprovedBy?"Authorized":e.status,report:e,jobName:t.name,shiftName:e.name,category:"air-monitoring"}))}))}catch(a){console.log("No shifts found for job ".concat(t._id,":"),a)}}catch(a){console.log("No air monitoring reports found for this project:",a)}n.sort(((t,e)=>e.date-t.date));const r=n.length>0?[n[0]]:[];console.log("Final reports array (most recent only):",r),console.log("Reports by type:",r.reduce(((t,e)=>(t[e.type]=(t[e.type]||0)+1,t)),{})),k(r)}catch(a){console.error("Error loading project reports:",a),E("Failed to load reports for this project")}finally{N(!1)}},H=t=>{switch(null===t||void 0===t?void 0:t.toLowerCase()){case"complete":case"completed":return"success";case"in progress":case"in_progress":return"warning";case"pending":return"info";case"cancelled":return"error";default:return"default"}};return L?(0,B.jsxs)(r.A,{sx:{p:3,textAlign:"center"},children:[(0,B.jsx)(s.A,{}),(0,B.jsx)(c.A,{sx:{mt:2},children:"Loading project reports..."})]}):z?(0,B.jsx)(r.A,{sx:{p:3},children:(0,B.jsx)(i.A,{severity:"error",children:z})}):(0,B.jsxs)(r.A,{sx:{p:3},children:[(0,B.jsxs)(r.A,{sx:{display:"flex",alignItems:"center",mb:3},children:[(0,B.jsx)(l.A,{onClick:()=>C("/reports"),sx:{mr:2},children:(0,B.jsx)(j.A,{})}),(0,B.jsxs)(r.A,{children:[(0,B.jsx)(c.A,{variant:"h4",component:"h1",gutterBottom:!0,children:"Project Reports"}),D&&(0,B.jsxs)(c.A,{variant:"h6",color:"text.secondary",children:[D.projectID," - ",D.name]})]})]}),(0,B.jsxs)(d.A,{sx:{p:3},children:[(0,B.jsxs)(c.A,{variant:"h6",gutterBottom:!0,children:["All Reports (",F.length,")"]}),F.length>0?(0,B.jsx)(p.A,{children:(0,B.jsxs)(g.A,{children:[(0,B.jsx)(h.A,{children:(0,B.jsxs)(m.A,{sx:{backgroundColor:t.primary[700]},children:[(0,B.jsx)(y.A,{sx:{color:"white",fontWeight:"bold"},children:"Date"}),(0,B.jsx)(y.A,{sx:{color:"white",fontWeight:"bold"},children:"Report Type"}),(0,B.jsx)(y.A,{sx:{color:"white",fontWeight:"bold"},children:"Status"}),(0,B.jsx)(y.A,{sx:{color:"white",fontWeight:"bold"},align:"center",children:"Actions"})]})}),(0,B.jsx)(u.A,{children:F.map((t=>(0,B.jsxs)(m.A,{hover:!0,children:[(0,B.jsx)(y.A,{children:t.date.toLocaleDateString("en-GB")}),(0,B.jsx)(y.A,{children:(0,B.jsxs)(r.A,{children:[(0,B.jsx)(c.A,{variant:"body2",fontWeight:"medium",children:t.type}),t.jobName&&(0,B.jsxs)(c.A,{variant:"caption",color:"text.secondary",children:[t.jobName," \u2022 ",t.shiftName]})]})}),(0,B.jsx)(y.A,{children:(0,B.jsx)(A.A,{label:t.status,color:H(t.status),size:"small"})}),(0,B.jsx)(y.A,{align:"center",children:(0,B.jsxs)(r.A,{sx:{display:"flex",gap:1,justifyContent:"center"},children:[(0,B.jsx)(f.A,{title:"View Report",children:(0,B.jsx)(l.A,{size:"small",onClick:()=>(async t=>{try{if("Air Monitoring Report"===t.type){var e;const a=t.report,o=await R.jobService.getById((null===(e=a.job)||void 0===e?void 0:e._id)||a.job),n=await R.sampleService.getByShift(a._id),r=await Promise.all(n.data.map((async t=>t.analysis?t:(await R.sampleService.getById(t._id)).data)));let s=o.data.project;if(s&&"string"===typeof s&&(s=(await I.A.getById(s)).data),s&&s.client&&"string"===typeof s.client){const t=await R.clientService.getById(s.client);s.client=t.data}(0,P.generateShiftReport)({shift:a,job:o.data,samples:r,project:s,openInNewTab:!0})}else if("Asbestos Clearance Report"===t.type){const e=t.report,o="object"===typeof e.clearanceId?e.clearanceId._id:e.clearanceId,n=a(82431).A,r=await n.post("/pdf/generate-asbestos-clearance",{clearanceData:{_id:o}},{responseType:"blob"}),s=new Blob([r.data],{type:"application/pdf"}),c=window.URL.createObjectURL(s);window.open(c,"_blank"),console.log("Asbestos clearance PDF opened in browser")}}catch(o){console.error("Error viewing report:",o),E("Failed to view report")}})(t),color:"primary",children:(0,B.jsx)(v.A,{})})}),(0,B.jsx)(f.A,{title:"Download Report",children:(0,B.jsx)(l.A,{size:"small",onClick:()=>(async t=>{try{if("Air Monitoring Report"===t.type){var e;const a=t.report,o=await R.jobService.getById((null===(e=a.job)||void 0===e?void 0:e._id)||a.job),n=await R.sampleService.getByShift(a._id),r=await Promise.all(n.data.map((async t=>t.analysis?t:(await R.sampleService.getById(t._id)).data)));let s=o.data.project;if(s&&"string"===typeof s&&(s=(await I.A.getById(s)).data),s&&s.client&&"string"===typeof s.client){const t=await R.clientService.getById(s.client);s.client=t.data}(0,P.generateShiftReport)({shift:a,job:o.data,samples:r,project:s,openInNewTab:!1})}else if("Asbestos Clearance Report"===t.type){const e=t.report,o=a(45360).A,n="object"===typeof e.clearanceId?e.clearanceId._id:e.clearanceId,r=await o.getById(n),{generateHTMLTemplatePDF:s}=a(43381),c=await s("asbestos-clearance",r);console.log("Asbestos clearance PDF downloaded successfully:",c)}}catch(o){console.error("Error downloading report:",o),E("Failed to download report")}})(t),color:"secondary",children:(0,B.jsx)(b.A,{})})}),(0,B.jsx)(f.A,{title:"Print Report",children:(0,B.jsx)(l.A,{size:"small",onClick:()=>(async t=>{try{if("Air Monitoring Report"===t.type){var e;const a=t.report,o=await R.jobService.getById((null===(e=a.job)||void 0===e?void 0:e._id)||a.job),n=await R.sampleService.getByShift(a._id),r=await Promise.all(n.data.map((async t=>t.analysis?t:(await R.sampleService.getById(t._id)).data)));let s=o.data.project;if(s&&"string"===typeof s&&(s=(await I.A.getById(s)).data),s&&s.client&&"string"===typeof s.client){const t=await R.clientService.getById(s.client);s.client=t.data}(0,P.generateShiftReport)({shift:a,job:o.data,samples:r,project:s,openInNewTab:!0}),setTimeout((()=>{window.print()}),1e3)}}catch(a){console.error("Error printing report:",a),E("Failed to print report")}})(t),color:"info",children:(0,B.jsx)(w.A,{})})})]})})]},t.id)))})]})}):(0,B.jsxs)(r.A,{sx:{textAlign:"center",py:4},children:[(0,B.jsx)(c.A,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:"No Reports Found"}),(0,B.jsx)(c.A,{variant:"body2",color:"text.secondary",children:"No reports have been generated for this project yet."})]})]})]})}}}]);
//# sourceMappingURL=549.fb4f1dcc.chunk.js.map