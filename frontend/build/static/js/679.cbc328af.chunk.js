"use strict";(self.webpackChunkair_monitoring_frontend=self.webpackChunkair_monitoring_frontend||[]).push([[679],{49679:(e,l,a)=>{a.r(l),a.d(l,{default:()=>N});var t=a(89379),r=a(65043),i=a(26240),o=a(96446),n=a(85865),s=a(11906),c=a(88911),d=a(53193),m=a(79190),p=a(72221),u=a(32143),h=a(15795),f=a(74605),x=a(51962),w=a(17392),j=a(73216),A=a(69120),g=a(39423),v=a(94505),F=a(79928),b=a(96458),S=a(95187),y=a(21291),k=a(70579);const N=()=>{const e=(0,i.A)(),{shiftId:l,sampleId:a}=(0,j.g)(),N=(0,j.Zp)(),{currentUser:T}=(0,S.As)(),[q,C]=(0,r.useState)([]),[B,I]=(0,r.useState)([]),[E,W]=(0,r.useState)([]),[D,_]=(0,r.useState)({sampler:"",sampleNumber:"",type:"",location:"",pumpNo:"",flowmeter:"",cowlNo:"",filterSize:"",startTime:"",endTime:"",initialFlowrate:"",finalFlowrate:"",averageFlowrate:"",notes:"",date:(0,y.rm)(new Date),isFieldBlank:!1}),[P,z]=(0,r.useState)(null),[L,M]=(0,r.useState)(null),[R,X]=(0,r.useState)(""),[J,U]=(0,r.useState)({}),[G,H]=(0,r.useState)(!1),[O,V]=(0,r.useState)(!0);(0,r.useEffect)((()=>{(async()=>{try{const e=await v.Dv.getAll();C(e.data)}catch(R){console.error("Error fetching users:",R)}})()}),[]),(0,r.useEffect)((()=>{(async()=>{try{const e=await F.A.filterByStatus("Active");I(e.data||e)}catch(R){console.error("Error fetching active air pumps:",R)}})()}),[]),(0,r.useEffect)((()=>{(async()=>{try{const e=await b.m.getAll();console.log("Equipment response:",e);const l=e.equipment||e.data||e;console.log("All equipment:",l);const a=l.filter((e=>("Bubble flowmeter"===e.equipmentType||"Site flowmeter"===e.equipmentType)&&"active"===e.status));console.log("Filtered flowmeters:",a),W(a)}catch(R){console.error("Error fetching active flowmeters:",R)}})()}),[]),(0,r.useEffect)((()=>{(async()=>{try{var e;V(!0);const l=(await v.sampleService.getById(a)).data;console.log("Fetched sample data:",l);const t=l.fullSampleID.split("-")[1];if(l.job&&l.job.project)z(l.job.project.projectID);else{const e=await v.jobService.getById(l.job);e.data&&e.data.project&&z(e.data.project.projectID)}_({sampleNumber:t,type:l.type,location:l.location,pumpNo:l.pumpNo||"",flowmeter:l.flowmeter||"",cowlNo:l.cowlNo||"",filterSize:l.filterSize||"",startTime:l.startTime||"",endTime:l.endTime||"",initialFlowrate:l.initialFlowrate||"",finalFlowrate:l.finalFlowrate||"",averageFlowrate:l.averageFlowrate||"",notes:l.notes||"",sampler:(null===(e=l.collectedBy)||void 0===e?void 0:e._id)||l.collectedBy||"",isFieldBlank:!(!l.isFieldBlank&&"Field blank"!==l.location)}),M(l.job),X(null)}catch(l){console.error("Error fetching sample:",l),X("Failed to load sample details")}finally{V(!1)}})()}),[a]);const Z=e=>{const{name:l,value:a,checked:r}=e.target;J[l]&&U((e=>(0,t.A)((0,t.A)({},e),{},{[l]:void 0}))),_("isFieldBlank"===l?e=>(0,t.A)((0,t.A)({},e),{},{[l]:r,location:r?"Field blank":e.location}):(0,t.A)((0,t.A)({},D),{},{[l]:a}))};(0,r.useEffect)((()=>{if(D.initialFlowrate)if(D.finalFlowrate){const e=(parseFloat(D.initialFlowrate)+parseFloat(D.finalFlowrate))/2;_((l=>(0,t.A)((0,t.A)({},l),{},{averageFlowrate:Math.round(e).toString()})))}else _((e=>(0,t.A)((0,t.A)({},e),{},{averageFlowrate:Math.round(parseFloat(D.initialFlowrate)).toString()})))}),[D.initialFlowrate,D.finalFlowrate]);const K=e=>{const l=new Date,a=l.getHours().toString().padStart(2,"0"),r=l.getMinutes().toString().padStart(2,"0"),i="".concat(a,":").concat(r);_((l=>(0,t.A)((0,t.A)({},l),{},{[e]:i})))};return O?(0,k.jsx)(o.A,{sx:{p:{xs:2,sm:3,md:4}},children:(0,k.jsx)(n.A,{children:"Loading sample details..."})}):R?(0,k.jsxs)(o.A,{sx:{p:{xs:2,sm:3,md:4}},children:[(0,k.jsx)(n.A,{color:"error",children:R}),(0,k.jsx)(s.A,{startIcon:(0,k.jsx)(A.A,{}),onClick:()=>N(-1),sx:{mt:2},children:"Back to Samples"})]}):G?(0,k.jsx)(o.A,{sx:{p:{xs:2,sm:3,md:4}},children:(0,k.jsx)(n.A,{children:"Updating sample..."})}):(0,k.jsxs)(o.A,{sx:{p:{xs:2,sm:3,md:4}},children:[(0,k.jsx)(s.A,{startIcon:(0,k.jsx)(A.A,{}),onClick:()=>N(-1),sx:{mb:4},children:"Back to Samples"}),(0,k.jsx)(n.A,{variant:"h4",sx:{color:"dark"===e.palette.mode?"#fff":e.palette.secondary[200],mb:4},children:"Edit Sample"}),(0,k.jsx)(o.A,{component:"form",onSubmit:async e=>{if(e.preventDefault(),X(""),U({}),(()=>{const e={};return D.sampler||(e.sampler="Sampler is required"),D.sampleNumber||(e.sampleNumber="Sample number is required"),D.flowmeter||(e.flowmeter="Flowmeter is required"),D.isFieldBlank||(D.location||(e.location="Location is required"),D.type||(e.type="Type is required"),D.startTime||(e.startTime="Start time is required"),D.initialFlowrate||(e.initialFlowrate="Initial flowrate is required")),U(e),0===Object.keys(e).length})()){H(!0);try{if(console.log("Starting sample update..."),console.log("Current user:",T),console.log("Form data:",D),console.log("Project ID:",P),console.log("Job:",L),!P)throw new Error("Project ID is required");if(null===L||void 0===L||!L._id)throw new Error("Job ID is required");if(!l)throw new Error("Shift ID is required");const e="".concat(P,"-").concat(D.sampleNumber);console.log("Generated full sample ID:",e);const t=D.type,r=e=>e?e.includes(":")?e:"".concat(e,":00"):"",i={shift:l,job:L._id,sampleNumber:D.sampleNumber,fullSampleID:e,type:t||void 0,location:D.location||void 0,pumpNo:D.pumpNo||void 0,flowmeter:D.flowmeter||void 0,cowlNo:D.cowlNo||void 0,filterSize:D.filterSize||void 0,startTime:D.startTime?r(D.startTime):void 0,endTime:D.endTime?r(D.endTime):void 0,initialFlowrate:D.initialFlowrate?parseFloat(D.initialFlowrate):void 0,finalFlowrate:D.finalFlowrate?parseFloat(D.finalFlowrate):void 0,averageFlowrate:D.averageFlowrate?parseFloat(D.averageFlowrate):void 0,status:"pending",notes:D.notes||void 0,collectedBy:D.sampler};await v.sampleService.update(a,i),N("/air-monitoring/shift/".concat(l,"/samples"))}catch(R){var t,r;console.error("Error updating sample:",R),X((null===(t=R.response)||void 0===t||null===(r=t.data)||void 0===r?void 0:r.message)||R.message||"Failed to update sample")}finally{H(!1)}}},noValidate:!0,children:(0,k.jsxs)(c.A,{spacing:3,sx:{maxWidth:600},children:[(0,k.jsxs)(d.A,{fullWidth:!0,required:!0,error:!!J.sampler,children:[(0,k.jsx)(m.A,{children:"Sampler"}),(0,k.jsx)(p.A,{name:"sampler",value:D.sampler,onChange:Z,label:"Sampler",required:!0,children:q.map((e=>(0,k.jsxs)(u.A,{value:e._id,children:[e.firstName," ",e.lastName]},e._id)))}),J.sampler&&(0,k.jsx)(n.A,{variant:"caption",color:"error",sx:{mt:.5},children:J.sampler})]}),(0,k.jsx)(h.A,{name:"sampleNumber",label:"Sample Number",value:D.sampleNumber,onChange:Z,required:!0,fullWidth:!0,error:!!J.sampleNumber,helperText:J.sampleNumber?J.sampleNumber:P?"Full Sample ID will be: ".concat(P,"-").concat(D.sampleNumber||"XXX"):"Loading job details..."}),(0,k.jsx)(f.A,{control:(0,k.jsx)(x.A,{name:"isFieldBlank",checked:D.isFieldBlank,onChange:Z}),label:"Field Blank"}),!D.isFieldBlank&&(0,k.jsxs)(k.Fragment,{children:[(0,k.jsxs)(d.A,{fullWidth:!0,required:!0,error:!!J.type,children:[(0,k.jsx)(m.A,{children:"Type"}),(0,k.jsxs)(p.A,{name:"type",value:D.type,onChange:Z,label:"Type",children:[(0,k.jsx)(u.A,{value:"Background",children:"Background"}),(0,k.jsx)(u.A,{value:"Clearance",children:"Clearance"}),(0,k.jsx)(u.A,{value:"Exposure",children:"Exposure"})]}),J.type&&(0,k.jsx)(n.A,{variant:"caption",color:"error",sx:{mt:.5},children:J.type})]}),(0,k.jsx)(h.A,{name:"location",label:"Location",value:D.location,onChange:Z,required:!0,fullWidth:!0,error:!!J.location,helperText:J.location})]}),D.isFieldBlank&&(0,k.jsx)(h.A,{name:"location",label:"Location",value:"Field blank",disabled:!0,required:!0,fullWidth:!0}),!D.isFieldBlank&&(0,k.jsxs)(k.Fragment,{children:[(0,k.jsxs)(d.A,{fullWidth:!0,children:[(0,k.jsx)(m.A,{children:"Pump No."}),(0,k.jsxs)(p.A,{name:"pumpNo",value:D.pumpNo,onChange:Z,label:"Pump No.",children:[(0,k.jsx)(u.A,{value:"",children:(0,k.jsx)("em",{children:"Select a pump"})}),B.map((e=>(0,k.jsxs)(u.A,{value:e.pumpReference,children:[e.pumpReference," - ",e.pumpDetails]},e._id)))]})]}),(0,k.jsx)(h.A,{name:"cowlNo",label:"Cowl No.",value:D.cowlNo,onChange:Z,required:!0,fullWidth:!0}),(0,k.jsxs)(d.A,{fullWidth:!0,children:[(0,k.jsx)(m.A,{children:"Filter Size"}),(0,k.jsxs)(p.A,{name:"filterSize",value:D.filterSize,onChange:Z,label:"Filter Size",children:[(0,k.jsx)(u.A,{value:"25mm",children:"25mm"}),(0,k.jsx)(u.A,{value:"13mm",children:"13mm"})]})]})]}),(0,k.jsxs)(d.A,{fullWidth:!0,required:!0,error:!!J.flowmeter,children:[(0,k.jsx)(m.A,{children:"Flowmeter"}),(0,k.jsxs)(p.A,{name:"flowmeter",value:D.flowmeter,onChange:Z,label:"Flowmeter",required:!0,children:[(0,k.jsx)(u.A,{value:"",children:(0,k.jsx)("em",{children:"Select a flowmeter"})}),E.map((e=>(0,k.jsxs)(u.A,{value:e.equipmentReference,children:[e.equipmentReference," - ",e.brandModel," (",e.equipmentType,")"]},e._id)))]}),J.flowmeter&&(0,k.jsx)(n.A,{variant:"caption",color:"error",sx:{mt:.5},children:J.flowmeter})]}),(0,k.jsxs)(o.A,{sx:{display:"flex",gap:1},children:[(0,k.jsx)(h.A,{name:"startTime",label:"Start Time",type:"time",value:D.startTime,onChange:Z,required:!0,fullWidth:!0,error:!!J.startTime,helperText:J.startTime,InputLabelProps:{shrink:!0},inputProps:{step:60}}),(0,k.jsx)(w.A,{onClick:()=>K("startTime"),sx:{alignSelf:"flex-end",mb:1},children:(0,k.jsx)(g.A,{})})]}),(0,k.jsxs)(o.A,{sx:{display:"flex",gap:1},children:[(0,k.jsx)(h.A,{name:"endTime",label:"End Time",type:"time",value:D.endTime,onChange:Z,fullWidth:!0,InputLabelProps:{shrink:!0},inputProps:{step:60}}),(0,k.jsx)(w.A,{onClick:()=>K("endTime"),sx:{alignSelf:"flex-end",mb:1},children:(0,k.jsx)(g.A,{})})]}),(0,k.jsx)(h.A,{name:"initialFlowrate",label:"Initial Flowrate (L/min)",type:"number",value:D.initialFlowrate,onChange:Z,required:!0,fullWidth:!0,error:!!J.initialFlowrate,helperText:J.initialFlowrate,inputProps:{step:"0.1"}}),(0,k.jsx)(h.A,{name:"finalFlowrate",label:"Final Flowrate (L/min)",type:"number",value:D.finalFlowrate,onChange:Z,fullWidth:!0,inputProps:{step:"0.1"}}),(0,k.jsx)(h.A,{name:"averageFlowrate",label:"Average Flowrate",value:D.averageFlowrate,disabled:!0,required:!0,fullWidth:!0}),(0,k.jsx)(h.A,{name:"notes",label:"Notes",value:D.notes,onChange:Z,multiline:!0,rows:3,fullWidth:!0}),(0,k.jsxs)(o.A,{sx:{display:"flex",gap:2,justifyContent:"flex-end"},children:[(0,k.jsx)(s.A,{variant:"outlined",onClick:()=>N(-1),children:"Cancel"}),(0,k.jsx)(s.A,{type:"submit",variant:"contained",sx:{backgroundColor:e.palette.primary.main,"&:hover":{backgroundColor:e.palette.primary.dark}},children:"Save Changes"})]})]})})]})}}}]);
//# sourceMappingURL=679.cbc328af.chunk.js.map